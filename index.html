<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar App (Google Auth)</title>

  <style>
    /* === Your existing CSS unchanged === */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .calendar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #ddd;
    }
    .calendar-cell {
      background-color: white;
      min-height: 100px;
      padding: 10px;
      cursor: pointer;
      user-select: none;
      overflow: hidden;
    }
    .day-header {
      background-color: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    .date-number {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .event {
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      margin-bottom: 2px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center; /* Adjusted for better look */
    }
    .nav-button {
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 8px 16px;
      cursor: pointer;
      width: auto;
      min-width: 100px;
    }
    .current-month {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }
    .event-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 300px;
      z-index: 1000;
    }
    .event-form input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .event-form h3 {
      margin-top: 0;
      margin-bottom: 15px;
    }
    .color-picker {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(25px, 1fr));
      gap: 5px;
      margin: 10px 0;
    }
    .color-option {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .color-option.selected {
      border: 2px solid #000;
    }
    .time-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .time-inputs div {
      flex: 1;
      min-width: 120px;
    }
    .time-inputs label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .event-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .event-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 80px;
    }
    .event-actions button:first-child {
      background: #4285f4;
      color: white;
    }
    .event-actions button:last-child {
      background: #ddd;
    }
    .delete-event-btn {
      background: #dc3545 !important;
      color: white;
    }
    .journal-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    .close-btn { /* This class was defined but not used, added just in case */
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .journal-textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      resize: vertical;
      box-sizing: border-box;
    }
    .other-month {
      background-color: #f5f5f5;
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      max-height: 200px; /* Adjust as needed */
      overflow-y: auto;
      position: relative; /* Needed for fade-out */
    }
    .task-item {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
      gap: 5px;
      transition: opacity 0.5s ease-out; /* Changed transition duration */
      opacity: 1;
    }
    .task-item.fade-out { /* Explicit fade-out class if needed, but inline style used */
      opacity: 0;
    }
    .task-item input[type="checkbox"] {
      margin-right: 10px;
      flex-shrink: 0; /* Prevent checkbox shrinking */
    }
    .task-item span {
        flex-grow: 1; /* Allow text to take available space */
        word-break: break-word; /* Wrap long task text */
    }
    .task-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .add-task-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      width: 100%;
    }
    .completed-task {
      text-decoration: line-through;
      color: #888;
    }
    .task-container {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      position: relative;
    }
    .task-toggle {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .task-toggle button {
      flex: 1;
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 4px;
      min-width: 120px;
    }
    .task-toggle button.active {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }
    .daily-events {
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .daily-events h4 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .add-event-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    .new-list-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto; /* Pushes it right */
      min-width: auto;
      flex: 0; /* Don't grow */
    }
    .delete-list-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: auto;
      flex: 0; /* Don't grow */
      display: none; /* Hide by default, shown by JS */
    }
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap; /* Allow wrapping on small screens */
      gap: 10px;
    }
    .tasks-header h3 {
        margin: 0; /* Remove default margin */
    }
    .tasks-header > div { /* Container for new/delete list buttons */
        display: flex;
        gap: 10px;
    }
    .change-habit-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1001; /* Ensure it's above other elements */
    }
    .habit-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    #habitDate {
      margin-bottom: 10px;
    }
    .new-habit-form {
      margin-top: 20px;
      display: none;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }
    .new-habit-form h4 {
      margin-top: 0;
    }
    .habit-type-options label {
      margin-right: 10px;
    }
    .goals-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      position: absolute; /* Position near top left */
      top: 10px;
      left: 10px;
      z-index: 1001;
    }
    .goals-form { /* Corrected selector */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none; /* Initially hidden */
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1000;
    }

    /* Responsive adjustments */
    @media screen and (max-width: 768px) {
      .calendar-grid {
        font-size: 14px;
      }
      .calendar-cell {
        min-height: 80px;
        padding: 5px;
      }
      .event {
        font-size: 10px;
        padding: 1px 3px;
      }
      .current-month {
        font-size: 16px;
        width: 100%;
        text-align: center;
        order: -1; /* Moves month name above buttons */
      }
      .nav-button {
        padding: 6px 12px;
        min-width: auto;
        flex: 1; /* Make nav buttons take equal space */
      }
      .journal-form button { /* General journal buttons */
         /* Removed specific styling here to avoid conflicts */
      }
      .goals-btn, .change-habit-btn {
          padding: 6px 10px; /* Smaller buttons on mobile */
          font-size: 12px;
      }
      .tasks-header > div {
          width: 100%; /* Stack new/delete buttons below title */
          justify-content: space-between;
      }
      .new-list-btn, .delete-list-btn {
          flex: 1; /* Make buttons share space */
          margin-left: 0;
      }
    }
    @media screen and (max-width: 480px) {
      body {
        padding: 10px;
      }
      .calendar-cell {
        min-height: 60px;
      }
      .day-header {
        padding: 5px;
        font-size: 12px;
      }
      .date-number {
        font-size: 12px;
      }
      .event {
        margin-bottom: 1px;
      }
      .event-form, .journal-form, .habit-form, .goals-form { /* Apply to all forms */
        width: 95%;
        padding: 15px;
      }
      .time-inputs div {
        flex: 100%; /* Stack time inputs */
      }
      .task-toggle button {
        flex: 100%; /* Stack task list buttons */
      }
      .journal-form > button:not(.goals-btn):not(.change-habit-btn) { /* Target only Save/Cancel */
        margin-top: 15px; /* Add space above Save/Cancel */
        padding: 12px;
        font-size: 16px;
        width: 100%; /* Make Save/Cancel full width */
        box-sizing: border-box;
      }
       .journal-form > button:nth-last-of-type(1) { /* Cancel button */
            margin-top: 10px; /* Space between Save and Cancel */
       }
       .goals-btn, .change-habit-btn {
          position: static; /* Remove absolute positioning */
          width: 100%;
          margin-bottom: 10px;
       }
       .journal-form h3 { /* Space below title if buttons are static */
           margin-bottom: 15px;
       }
    }
  </style>
</head>
<body>

<!-- Auth Section -->
<div id="authSection" style="display: none; text-align:center; margin-bottom: 20px;">
  <button onclick="loginWithGoogle()" style="background: #DB4437; color:white; padding: 10px 20px; border:none; border-radius:4px; cursor:pointer;">
    Sign in with Google
  </button>
</div>

<!-- Logout Button -->
<div id="logoutSection" style="display: none; text-align:right; margin-bottom: 20px;">
  <button onclick="logoutFromGoogle()" style="background: #4285F4; color:white; padding: 8px 16px; border:none; border-radius:4px; cursor:pointer;">
    Sign Out
  </button>
</div>

<!-- Calendar Container -->
<div class="calendar-container">
  <div class="calendar-header">
    <button class="nav-button" onclick="previousMonth()">< Previous</button>
    <div class="current-month">September 2023</div> <!-- Will be updated by JS -->
    <button class="nav-button" onclick="nextMonth()">Next ></button>
  </div>
  <div class="calendar-grid">
    <!-- Day Headers (cloned by JS) -->
    <div class="day-header">Sun</div>
    <div class="day-header">Mon</div>
    <div class="day-header">Tue</div>
    <div class="day-header">Wed</div>
    <div class="day-header">Thu</div>
    <div class="day-header">Fri</div>
    <div class="day-header">Sat</div>
    <!-- Calendar cells generated by JS -->
  </div>
</div>

<!-- Event Form -->
<div class="event-form" id="eventForm">
  <h3>Add/Edit Event</h3> <!-- Changed Title -->
  <input type="text" id="eventDescription" placeholder="Event Name" required>
  <div class="time-inputs">
    <div>
      <label for="eventStartTime">Start Time:</label>
      <input type="time" id="eventStartTime" required>
    </div>
    <div>
      <label for="eventEndTime">End Time:</label>
      <input type="time" id="eventEndTime" required>
    </div>
  </div>
  <h4>Select Color:</h4>
  <div class="color-picker" id="colorPicker"></div>
  <input type="hidden" id="eventDate">
  <input type="hidden" id="eventId"> <!-- Stores index for editing -->
  <div class="event-actions">
    <button onclick="saveEvent()">Save Event</button>
    <button onclick="deleteEvent()" class="delete-event-btn" style="display: none;">Delete</button> <!-- Hide initially -->
    <button onclick="closeEventForm()">Cancel</button>
  </div>
</div>

<!-- Journal Form -->
<div class="journal-form" id="journalForm" data-date=""> <!-- data-date set by JS -->
    <button class="goals-btn" onclick="goToGoalsPage()">Go To Goals</button>
    <button class="change-habit-btn" onclick="changeToHabit()">Change to Habit</button>
    <h3>Daily Overview</h3>
    <div id="journalDate" style="margin-bottom: 10px; font-weight: bold; text-align: center;"></div> <!-- Centered Date -->

    <!-- Events for the Day -->
    <div class="daily-events">
      <h4>Events</h4>
      <div id="dailyEventsList"></div> <!-- Populated by JS -->
      <button class="add-event-btn" onclick="addEvent(document.getElementById('journalForm').dataset.date)">Add Event for this Day</button> <!-- Clarified button text -->
    </div>

    <!-- Journal Entry -->
    <h4>Journal Entry</h4>
    <textarea id="journalText" class="journal-textarea" placeholder="Write your thoughts for this day..."></textarea>

    <!-- Tasks Section -->
    <div class="task-container">
      <div class="tasks-header">
        <h3>Tasks</h3>
        <div>
          <!-- Buttons call *Direct functions exposed globally -->
          <button class="new-list-btn" onclick="createNewListDirect()">+ New List</button>
          <button class="delete-list-btn" onclick="deleteCurrentListDirect()">Delete List</button>
        </div>
      </div>
      <div class="task-toggle">
        <!-- Buttons are generated/managed by fixTaskButtons JS function -->
        <!-- Initial placeholders removed to avoid duplication by JS -->
      </div>

      <label style="display: block; margin: 15px 0 8px; font-size: 14px;">
        <input type="checkbox" id="taskDailyCheckbox" style="margin-right: 6px;">
        Repeat Daily?
      </label>

      <input type="text" id="taskInput" class="task-input" placeholder="Add a new task (or multiple, comma-separated)">
      <!-- Button calls *Direct function exposed globally -->
      <button class="add-task-btn" onclick="addTaskDirect()">Add Task</button>
      <ul class="task-list" id="taskList">
        <!-- Task items generated by JS -->
      </ul>
    </div>

    <!-- Save/Cancel Buttons for Journal -->
    <button onclick="saveJournal()">Save Journal & Tasks</button> <!-- Clarified button text -->
    <button onclick="closeJournalForm()">Cancel</button>
</div>


<!-- Prev / Next Journal Buttons -->
<button id="prevDayButton"
  class="nav-button"
  style="position:fixed; left:20px; top:50%; transform:translateY(-50%); z-index:1001; display:none;"
  onclick="changeJournalDay(-1)"><</button>

<button id="nextDayButton"
  class="nav-button"
  style="position:fixed; right:20px; top:50%; transform:translateY(-50%); z-index:1001; display:none;"
  onclick="changeJournalDay(1)">></button>

<!-- Habit Form -->
<div class="habit-form" id="habitForm" style="display: none;" data-date="">
  <button class="change-habit-btn" onclick="changeToJournal()">Change to Journal</button> <!-- Reuse class -->
  <h3>Habit Tracker</h3>
  <div id="habitDate" style="margin-bottom: 10px; font-weight: bold;"></div>
  <div id="habitList"></div>
  <button onclick="showNewHabitForm()">Add Habit</button>

  <!-- New Habit Creation Sub-Form -->
  <div class="new-habit-form" id="newHabitForm">
    <h4>Add a New Habit</h4>
    <input type="text" id="newHabitName" placeholder="Habit Name" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
    <div class="habit-type-options" style="margin-bottom: 15px;">
      <label><input type="radio" name="habitType" value="count" checked> Count (e.g., glasses of water)</label><br>
      <label><input type="radio" name="habitType" value="check"> Check (e.g., exercised)</label>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="confirmAddHabit()" style="flex: 1; background: #4CAF50; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Save New Habit</button>
        <button onclick="cancelAddHabit()" style="flex: 1; background: #ddd; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
    </div>
  </div>

  <!-- Save/Cancel for Habit Form -->
  <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button onclick="saveHabitTracker()" style="flex: 1; background: #4285f4; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer;">Save Habits</button>
      <button onclick="cancelHabitTracker()" style="flex: 1; background: #ddd; padding: 10px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
  </div>
</div>


<!-- Goals Form -->
<div class="goals-form" id="goalsForm"> <!-- Removed inline style -->
  <button onclick="goToJournalFromGoals()"
    style="position: absolute; top: 10px; right: 10px; background:#4285f4; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
    Go to Journal
  </button>
  <h3>Goals</h3>
  <p>Write your long-term or overarching goals here.</p>
  <textarea id="goalsText" style="width:100%; height:200px; box-sizing: border-box; padding: 10px;" placeholder="e.g., Run a marathon, Learn a new language..."></textarea>
  <div style="display: flex; gap: 10px; margin-top: 20px;">
    <button onclick="saveGoals()" style="flex:1; background:#4285f4; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">
      Save Goals
    </button>
    <button onclick="closeGoalsForm()" style="flex:1; background:#ddd; border:none; padding:10px; border-radius:4px; cursor:pointer;">
      Close
    </button>
  </div>
</div>


<!-- ====================== Firebase + App Script ====================== -->
<script type="module">
  /**********************
    1) Firebase Imports
  ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js"; // Added updateDoc

  /**********************
    2) Firebase Config
  ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyCmtc69JDgCWtxPNgPU73Y4n7-asl6M72w",
    authDomain: "my-website-5dfa1.firebaseapp.com",
    projectId: "my-website-5dfa1",
    storageBucket: "my-website-5dfa1.firebasestorage.app",
    messagingSenderId: "36790147861",
    appId: "1:36790147861:web:6391e58fe3193c4fabe71c",
    measurementId: "G-SSJEV8WQFT"
  };

  /**********************
    3) Init Firebase
  ***********************/
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  let userId = null;
  const provider = new GoogleAuthProvider();

  async function loginWithGoogle() {
    try {
      await signInWithPopup(auth, provider);
      console.log("Google sign-in successful!");
      // onAuthStateChanged will handle UI updates and data loading
    } catch (error) {
      console.error("Google Sign-In Error:", error);
      alert("Failed to sign in with Google. Please check console for details.");
    }
  }

  async function logoutFromGoogle() {
    try {
      await signOut(auth);
      console.log("User signed out successfully");
      // onAuthStateChanged will handle UI updates and data clearing
    } catch (error) {
      console.error("Error signing out:", error);
    }
  }

  /*******************************************************
   4) In-Memory Data & State
  *******************************************************/
  let currentDate   = new Date();
  let events        = [];
  let selectedColor = '#4285f4'; // Default event color
  let journalEntries = {};
  let taskLists     = { personal: [], work: [] }; // Default task lists
  let currentTaskList = 'personal'; // Default view
  let habitTracker = {}; // { 'YYYY-MM-DD': { habitId1: value, habitId2: value }, ... }
  let globalHabits = []; // [ { id: 'habitId1', name: 'Drink Water', type: 'count' }, ... ]
  let userGoals = ''; // Store goals text

  /*******************************************************
   5) Firestore Load/Save
  *******************************************************/
  async function loadUserData() {
    if (!userId) return;
    console.log("Loading user data for:", userId);
    try {
      const docRef = doc(db, "users", userId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        console.log("Firestore data found:", data);
        events          = data.events          || [];
        journalEntries  = data.journalEntries  || {};
        taskLists       = data.taskLists       || { personal: [], work: [] };
        habitTracker    = data.habitTracker    || {};
        globalHabits    = data.globalHabits    || [];
        userGoals       = data.userGoals       || '';

        // Ensure default task lists exist if loaded data is missing them
        if (!taskLists.personal) taskLists.personal = [];
        if (!taskLists.work) taskLists.work = [];

        document.getElementById('goalsText').value = userGoals; // Load goals into textarea

        // Reset current task list view to default after loading
        currentTaskList = 'personal';

      } else {
        console.log("No existing Firestore doc for this user; starting fresh.");
        // Initialize with defaults if no doc exists
        events = [];
        journalEntries = {};
        taskLists = { personal: [], work: [] };
        habitTracker = {};
        globalHabits = [];
        userGoals = '';
        currentTaskList = 'personal';
        document.getElementById('goalsText').value = '';
        // Optionally create the document immediately for new users
        // await saveUserData();
      }
    } catch (err) {
      console.error("Error loading user data:", err);
      alert("Error loading your data. Please check the console and try refreshing.");
    }
  }

  async function saveUserData() {
    if (!userId) {
        console.warn("Attempted to save data without userId.");
        return; // Not signed in
    }
    console.log("Saving user data to Firestore for:", userId);
    try {
      const docRef = doc(db, "users", userId);
      await setDoc(docRef, {
        events: events || [], // Ensure saving empty arrays if needed
        journalEntries: journalEntries || {},
        taskLists: taskLists || { personal: [], work: [] },
        habitTracker: habitTracker || {},
        globalHabits: globalHabits || [],
        userGoals: document.getElementById('goalsText')?.value || '' // Get current goals text
      }, { merge: true }); // Use merge: true to avoid overwriting fields if only partial data is sent (though here we send all)
      console.log("Data saved successfully to Firestore!");
    } catch (err) {
      console.error("Error saving user data:", err);
      alert("Error saving your data. Please check the console.");
    }
  }

  /*******************************************************
   6) Color Picker
  *******************************************************/
  const colors = [
    '#FF0000','#FF4500','#FF6B6B','#FFA500','#FFD700','#F1C40F','#FFEEAD',
    '#90EE90','#2ECC71','#27AE60','#16A085','#96CEB4','#4ECDC4',
    '#45B7D1','#3498DB','#2980B9','#0000FF','#8E44AD','#9B59B6','#D4A5A5'
  ];

  function initializeColorPicker() {
    const colorPicker = document.getElementById('colorPicker');
    if (!colorPicker) return; // Guard against element not found
    colorPicker.innerHTML = ''; // Clear previous options
    let defaultSelected = false;

    colors.forEach(color => {
      const colorOption = document.createElement('div');
      colorOption.className = 'color-option';
      colorOption.style.backgroundColor = color;
      colorOption.dataset.color = color; // Store color in data attribute

      // Select the current color if editing, or the default if adding
      if (color === selectedColor) {
        colorOption.classList.add('selected');
        defaultSelected = true;
      }

      colorOption.onclick = () => {
        // Remove selected class from all options
        colorPicker.querySelectorAll('.color-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        // Add selected class to the clicked option
        colorOption.classList.add('selected');
        selectedColor = color; // Update the global selectedColor variable
        console.log("Color selected:", selectedColor);
      };
      colorPicker.appendChild(colorOption);
    });

    // If the `selectedColor` wasn't in the list, select the first one as default
     if (!defaultSelected && colorPicker.firstChild) {
        colorPicker.firstChild.classList.add('selected');
        selectedColor = colorPicker.firstChild.dataset.color;
     }
  }


  /*******************************************************
   7) Calendar Navigation
  *******************************************************/
  function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
  }

  /*******************************************************
   8) Calendar Generation
  *******************************************************/
  function generateCalendar() {
    const monthYearDisplay = document.querySelector('.current-month');
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!monthYearDisplay || !calendarGrid) {
        console.error("Calendar elements not found!");
        return;
    }

    // Clear previous grid cells, keeping headers
    const headers = calendarGrid.querySelectorAll('.day-header');
    calendarGrid.innerHTML = ''; // Clear everything
    headers.forEach(header => calendarGrid.appendChild(header.cloneNode(true))); // Add headers back

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthNames = ["January","February","March","April","May","June",
                        "July","August","September","October","November","December"];
    monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth  = new Date(year, month + 1, 0);
    const firstDayWeekday = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon, ...

    // --- Add cells for previous month's days ---
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    for (let i = firstDayWeekday; i > 0; i--) {
      const day = daysInPrevMonth - i + 1;
      const prevDate = new Date(year, month - 1, day);
      const cell = createCalendarCell(prevDate, true); // true indicates other month
      calendarGrid.appendChild(cell);
    }

    // --- Add cells for current month's days ---
    for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
      const date = new Date(year, month, day);
      const cell = createCalendarCell(date, false); // false indicates current month
      calendarGrid.appendChild(cell);
    }

    // --- Add cells for next month's days ---
    const lastDayWeekday = lastDayOfMonth.getDay();
    const cellsToAdd = 6 - lastDayWeekday; // Number of cells needed to fill the last row (up to Saturday)
    // Ensure grid always has 6 rows (42 cells total including headers) for consistency
    const totalCells = firstDayWeekday + lastDayOfMonth.getDate() + cellsToAdd;
    const extraCellsNeeded = (totalCells <= 35) ? 7 : 0; // Add a full row if only 5 rows are filled

    for (let i = 1; i <= cellsToAdd + extraCellsNeeded; i++) {
      const nextDate = new Date(year, month + 1, i);
      const cell = createCalendarCell(nextDate, true); // true indicates other month
      calendarGrid.appendChild(cell);
    }
     console.log(`Calendar generated for ${monthNames[month]} ${year}`);
  }


  function createCalendarCell(date, isOtherMonth) {
    const cell = document.createElement('div');
    cell.className = `calendar-cell${isOtherMonth ? ' other-month' : ''}`;
    const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format

    // Add date number
    const dateNumber = document.createElement('div');
    dateNumber.className = 'date-number';
    dateNumber.textContent = date.getDate();
    cell.appendChild(dateNumber);

    // Add click listener to open journal (only for current month days usually, but allow for others too)
    cell.addEventListener('click', () => openJournal(dateStr));

    // --- Display Events ---
    const dayEvents = events.filter(event => event.date === dateStr)
                           .sort((a, b) => (a.startTime || '').localeCompare(b.startTime || '')); // Sort by start time

    dayEvents.forEach((event, index) => {
      // Limit number of visible events to avoid overflow, maybe add a "+ more" indicator later
      if (index < 3) { // Show max 3 events directly
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.style.backgroundColor = event.color || '#3498DB'; // Default color if missing
          eventDiv.textContent = event.description;
          eventDiv.title = `${event.startTime || ''} - ${event.endTime || ''}: ${event.description}`; // Tooltip
          eventDiv.onclick = (e) => {
            e.stopPropagation(); // Prevent opening journal when clicking event
            editEvent(event, events.indexOf(event)); // Pass index for easier editing/deletion
          };
          cell.appendChild(eventDiv);
      } else if (index === 3) {
         const moreDiv = document.createElement('div');
         moreDiv.className = 'event';
         moreDiv.style.backgroundColor = '#ccc';
         moreDiv.style.color = '#333';
         moreDiv.textContent = '+ more';
         moreDiv.onclick = (e) => { e.stopPropagation(); openJournal(dateStr); }; // Open journal to see all
         cell.appendChild(moreDiv);
      }
    });

    // --- Display Journal Indicator ---
    if (journalEntries[dateStr]) {
      const journalIndicator = document.createElement('div');
      journalIndicator.className = 'event'; // Reuse event styling
      journalIndicator.style.backgroundColor = '#666'; // Distinct color for journal
      journalIndicator.textContent = 'ðŸ“'; // Emoji indicator
      journalIndicator.title = 'Journal entry exists';
      journalIndicator.style.textAlign = 'center';
      journalIndicator.onclick = (e) => { e.stopPropagation(); openJournal(dateStr); }; // Also open journal
      cell.appendChild(journalIndicator);
    }

    // --- Display Habit Indicator (Optional) ---
    // Check if any habits are tracked for this day
    if (habitTracker[dateStr] && Object.keys(habitTracker[dateStr]).length > 0 && globalHabits.length > 0) {
        const habitIndicator = document.createElement('div');
        habitIndicator.className = 'event';
        habitIndicator.style.backgroundColor = '#FFA07A'; // Light Salmon for habits
        habitIndicator.textContent = 'ðŸŽ¯'; // Target emoji
        habitIndicator.title = 'Habits tracked';
        habitIndicator.style.textAlign = 'center';
        habitIndicator.onclick = (e) => { e.stopPropagation(); openJournal(dateStr); }; // Open journal (which can lead to habits)
        cell.appendChild(habitIndicator);
    }

    return cell;
  }


  /*******************************************************
   9) Open/Close Forms & Navigation
  *******************************************************/
  function openJournal(date) {
    const journalForm = document.getElementById('journalForm');
    const journalDateEl = document.getElementById('journalDate'); // Renamed element variable
    const journalText = document.getElementById('journalText');
    if (!journalForm || !journalDateEl || !journalText) return; // Safety check

    // Format date nicely for display
    const displayDate = new Date(date + 'T00:00:00'); // Add time to avoid timezone issues
    journalDateEl.textContent = displayDate.toLocaleDateString(undefined, {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    journalText.value = journalEntries[date] || ''; // Load existing entry or empty string
    journalForm.dataset.date = date; // Store YYYY-MM-DD date

    // Make Journal visible and hide other potentially open forms
    document.getElementById('eventForm').style.display = 'none';
    document.getElementById('habitForm').style.display = 'none';
    document.getElementById('goalsForm').style.display = 'none';
    journalForm.style.display = 'block';

    // Show navigation buttons
    document.getElementById('prevDayButton').style.display = 'block';
    document.getElementById('nextDayButton').style.display = 'block';

    // Update content within the journal
    updateDailyEventsList(date);

    // --- Initialize Tasks Section for this Date ---
    fixTaskButtons(); // Ensure toggle buttons are correct (incl. custom lists)
    // Crucially, call switchTaskDirect to set active button AND render tasks for the journal's date
    switchTaskDirect(currentTaskList);

    console.log("Opened journal for:", date);
  }

  function closeJournalForm() {
    document.getElementById('journalForm').style.display = 'none';
    document.getElementById('prevDayButton').style.display = 'none';
    document.getElementById('nextDayButton').style.display = 'none';
    console.log("Closed journal form.");
  }

   function closeEventForm() {
    document.getElementById('eventForm').style.display = 'none';
    selectedColor = '#4285f4'; // Reset selected color
    // Optionally, reopen the journal if it was open before editing/adding event
    // This requires tracking state, might be simpler to just close it.
    // const journalDate = document.getElementById('journalForm').dataset.date;
    // if (journalDate) { openJournal(journalDate); }
  }

  function closeHabitForm() { // Renamed from cancelHabitTracker for clarity
    document.getElementById('habitForm').style.display = 'none';
    document.getElementById('newHabitForm').style.display = 'none'; // Hide add form too
    // Re-open journal for the same date
    const habitDate = document.getElementById('habitForm').dataset.date;
    if (habitDate) {
        openJournal(habitDate);
    }
  }
  window.cancelHabitTracker = closeHabitForm; // Keep alias if needed elsewhere


  function closeGoalsForm() {
    document.getElementById('goalsForm').style.display = 'none';
    // Decide where to return: last journal date or just close?
    // Let's just close it for simplicity.
  }

  function changeJournalDay(direction) {
    const journalForm = document.getElementById('journalForm');
    const currentDateStr = journalForm.dataset.date;
    if (!currentDateStr) return;

    const [year, month, day] = currentDateStr.split('-').map(Number);
    // JavaScript months are 0-indexed, so month-1
    const currentDateObj = new Date(year, month - 1, day);
    currentDateObj.setDate(currentDateObj.getDate() + direction); // Add or subtract a day

    const newDateStr = currentDateObj.toISOString().split('T')[0];
    openJournal(newDateStr); // Open journal for the new date
  }

  // --- Navigation between Journal/Habit/Goals ---
  function changeToHabit() {
    const journalForm = document.getElementById('journalForm');
    const date = journalForm.dataset.date;
    if (!date) return;
    closeJournalForm(); // Close journal first
    openHabitTracker(date);
  }

  function changeToJournal() {
    const habitForm = document.getElementById('habitForm');
    const date = habitForm.dataset.date;
    if (!date) return;
    closeHabitForm(); // Close habit tracker first
    openJournal(date);
  }

  function goToGoalsPage() {
    closeJournalForm(); // Close journal first
    document.getElementById('goalsForm').style.display = 'block';
    // Load goals text (already loaded into variable userGoals by loadUserData)
    document.getElementById('goalsText').value = userGoals;
  }

  function goToJournalFromGoals() {
    const goalsForm = document.getElementById('goalsForm');
    goalsForm.style.display = 'none';
    // Re-open journal for the *current* date (or last viewed date?)
    // Let's use the date from the main calendar view
    const todayStr = new Date().toISOString().split('T')[0];
    // Check if a journal was previously open and use that date? Requires state tracking.
    // Simpler: open for today or the calendar's current date center.
     const journalDate = document.getElementById('journalForm').dataset.date || todayStr;
    openJournal(journalDate);
  }


  /*******************************************************
   10) Events Management
  *******************************************************/
  function addEvent(date) { // Called from calendar cell or journal 'add event' button
    if (!date) {
        console.error("Add event called without a date.");
        return;
    }
    const eventForm = document.getElementById('eventForm');
    const deleteBtn = eventForm.querySelector('.delete-event-btn');

    // Reset form fields
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventStartTime').value = ''; // Consider setting a default like 09:00?
    document.getElementById('eventEndTime').value = '';   // Consider setting a default like 10:00?
    document.getElementById('eventDate').value = date;
    document.getElementById('eventId').value = ''; // Clear event ID - indicates a new event
    selectedColor = '#4285f4'; // Reset to default color

    initializeColorPicker(); // Initialize with default selected

    deleteBtn.style.display = 'none'; // Hide delete button for new events
    eventForm.style.display = 'block';
    eventForm.style.zIndex = '1002'; // Ensure it's above journal/habit form if open

    // Optional: Close journal/habit form if open
    document.getElementById('journalForm').style.display = 'none';
    document.getElementById('habitForm').style.display = 'none';
    // Hide day navigation buttons when event form is open
    document.getElementById('prevDayButton').style.display = 'none';
    document.getElementById('nextDayButton').style.display = 'none';

    console.log("Opening event form to add event for date:", date);
  }

  function editEvent(event, index) {
    const eventForm = document.getElementById('eventForm');
    const deleteBtn = eventForm.querySelector('.delete-event-btn');
    if (index === undefined || index < 0 || index >= events.length) {
        console.error("Invalid index provided for editing event:", index, event);
        // Try finding index based on event object if index is bad
        index = events.findIndex(e => e.id === event.id && e.date === event.date); // Assumes unique ID per day
         if (index === -1) {
            alert("Could not find the event to edit.");
            return;
         }
    }

    // Populate form with event data
    document.getElementById('eventDescription').value = event.description || '';
    document.getElementById('eventStartTime').value = event.startTime || '';
    document.getElementById('eventEndTime').value = event.endTime || '';
    document.getElementById('eventDate').value = event.date;
    document.getElementById('eventId').value = index; // Store the index for saving/deleting
    selectedColor = event.color || '#4285f4'; // Use event's color or default

    initializeColorPicker(); // Initialize and select the event's color

    deleteBtn.style.display = 'block'; // Show delete button when editing
    eventForm.style.display = 'block';
    eventForm.style.zIndex = '1002';

    // Close journal/habit form if open
    document.getElementById('journalForm').style.display = 'none';
    document.getElementById('habitForm').style.display = 'none';
     // Hide day navigation buttons when event form is open
    document.getElementById('prevDayButton').style.display = 'none';
    document.getElementById('nextDayButton').style.display = 'none';

    console.log("Opening event form to edit event:", event, "at index:", index);
  }

  function saveEvent() {
    const date = document.getElementById('eventDate').value;
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const description = document.getElementById('eventDescription').value.trim();
    const eventId = document.getElementById('eventId').value; // This is the index as a string or ""

    if (!description) {
      alert('Please enter an event description.');
      return;
    }
     if (startTime && endTime && endTime <= startTime) {
      alert('End time must be after start time.');
      return;
    }
    // Optional: Add validation for date format if needed

    const eventData = {
        date,
        startTime,
        endTime,
        description,
        color: selectedColor,
        id: eventId !== '' ? events[parseInt(eventId)].id : Date.now().toString() // Keep old ID or generate new
    };

    if (eventId !== '') {
      // Editing existing event
      const index = parseInt(eventId);
      if (index >= 0 && index < events.length) {
          events[index] = eventData;
          console.log("Event updated:", eventData);
      } else {
          console.error("Invalid index for updating event:", index);
          alert("Error updating event. Invalid index.");
          return;
      }
    } else {
      // Adding new event
      events.push(eventData);
      console.log("Event added:", eventData);
    }

    saveUserData(); // Save the updated events array to Firestore

    closeEventForm();
    generateCalendar(); // Update the main calendar view

    // Re-open journal for the event's date to see the updated list
    openJournal(date);
  }

  function deleteEvent() {
    const eventId = document.getElementById('eventId').value; // This is the index
    const date = document.getElementById('eventDate').value;

    if (eventId === '') {
      // Should not happen if delete button is hidden for new events, but safety check
      console.warn("Delete called on an event with no ID (likely a new event).");
      closeEventForm();
      openJournal(date); // Go back to journal
      return;
    }

    const index = parseInt(eventId);
    if (index >= 0 && index < events.length) {
      if (confirm(`Are you sure you want to delete the event "${events[index].description}"?`)) {
        const deletedEvent = events.splice(index, 1); // Remove the event from the array
        console.log("Event deleted:", deletedEvent);
        saveUserData(); // Save the change
        closeEventForm();
        generateCalendar(); // Update main calendar
        openJournal(date); // Re-open journal for that date
      }
    } else {
      console.error("Invalid index for deleting event:", index);
      alert("Error deleting event. Invalid index.");
      closeEventForm();
      openJournal(date);
    }
  }

  function updateDailyEventsList(date) {
    const dailyEventsList = document.getElementById('dailyEventsList');
    if (!dailyEventsList) return;

    dailyEventsList.innerHTML = ''; // Clear previous list
    const dayEvents = events.filter(event => event.date === date)
                           .sort((a, b) => (a.startTime || '').localeCompare(b.startTime || '')); // Sort by time

    if (dayEvents.length === 0) {
      dailyEventsList.innerHTML = '<p style="color: #666; font-style: italic;">No events scheduled for this day.</p>';
      return;
    }

    dayEvents.forEach((event) => {
      const eventDiv = document.createElement('div');
      eventDiv.className = 'event'; // Reusing calendar event style, maybe create a specific journal-event style
      eventDiv.style.backgroundColor = event.color || '#3498DB';
      eventDiv.style.color = 'white'; // Ensure text is readable
      eventDiv.style.margin = '5px 0';
      eventDiv.style.padding = '8px';
      eventDiv.style.borderRadius = '4px';
      eventDiv.style.cursor = 'pointer';
      eventDiv.style.textAlign = 'left'; // Align text left for list view
      eventDiv.style.whiteSpace = 'normal'; // Allow wrapping
      eventDiv.textContent = `${event.startTime || 'All day'} ${event.endTime ? '- '+event.endTime : ''}: ${event.description}`;
      eventDiv.onclick = () => editEvent(event, events.indexOf(event)); // Allow editing from list
      dailyEventsList.appendChild(eventDiv);
    });
  }


  /*******************************************************
   11) Journal Entry Management
  *******************************************************/
  function saveJournal() {
    const journalForm = document.getElementById('journalForm');
    const date = journalForm.dataset.date;
    const text = document.getElementById('journalText').value;

    if (!date) {
        console.error("Cannot save journal: date is missing.");
        return;
    }

    if (text.trim()) {
        journalEntries[date] = text.trim(); // Store trimmed text
        console.log("Journal entry saved for:", date);
    } else {
        // If text is empty, remove the entry for that date
        delete journalEntries[date];
        console.log("Journal entry removed for:", date, "(was empty)");
    }

    // Note: Task saving happens separately via addTaskDirect, toggleTaskDirect etc.
    // This function only saves the journal text itself.
    saveUserData(); // Save journalEntries and potentially other data if needed
    closeJournalForm();
    generateCalendar(); // Update calendar to show/hide journal indicator
  }

  /*******************************************************
   12) Goals Management
  *******************************************************/
  function saveGoals() {
    userGoals = document.getElementById('goalsText').value; // Update the global variable
    console.log("Goals saved:", userGoals);
    saveUserData(); // Save all user data, including the updated goals
    closeGoalsForm();
    // Optionally reopen the journal or stay closed
    // goToJournalFromGoals(); // Uncomment if you want to return to journal
  }

  // goToGoalsPage, closeGoalsForm, goToJournalFromGoals are in Section 9


  /*******************************************************
   13) Task Lists - *Direct Functions (Globally Exposed)
  *******************************************************/

  function renderTasks() {
    const taskListContainer = document.getElementById('taskList'); // Corrected variable name
    if (!taskListContainer) {
        console.error("Task list container 'taskList' not found!");
        return;
    }
    taskListContainer.innerHTML = ''; // Clear previous tasks

    // Ensure current task list exists in data
    if (!taskLists[currentTaskList]) {
      taskLists[currentTaskList] = [];
       console.warn(`Task list "${currentTaskList}" was missing, created empty array.`);
    }

    const tasks = taskLists[currentTaskList];
    const journalForm = document.getElementById('journalForm');
    // Ensure journalForm has a date, default to today if not set yet (e.g., if task list is viewed outside journal)
    const dateKey = journalForm?.dataset?.date || new Date().toISOString().split('T')[0];

    console.log(`Rendering tasks for list: "${currentTaskList}", Date: ${dateKey}`);
    // console.log("Tasks:", tasks);


    if (!tasks || tasks.length === 0) {
      const emptyMessage = document.createElement('p');
      emptyMessage.textContent = 'No tasks in this list yet.';
      emptyMessage.style.color = '#666';
      emptyMessage.style.fontStyle = 'italic';
      emptyMessage.style.padding = '10px 0';
      taskListContainer.appendChild(emptyMessage);
      return;
    }

    let tasksToShow = 0;
    tasks.forEach(task => {
      if (!task || typeof task.id === 'undefined') {
          console.warn("Skipping invalid task object:", task);
          return; // Skip malformed tasks
      }

      // Determine if task should be shown based on completion status and type
      const isCompletedToday = (task.repeat === 'daily' && task.completions && task.completions[dateKey]);
      const isCompletedOnce = (task.repeat === 'once' && task.completed);

      // --- Filter Logic: Only show tasks relevant for the current view ---
      // Don't render already completed 'once' tasks in the active list.
      // Don't render 'daily' tasks if they are completed *for the current dateKey*.
      if (isCompletedOnce || isCompletedToday) {
           // console.log(`Skipping render for completed task: ${task.text} (once: ${isCompletedOnce}, dailyToday: ${isCompletedToday})`);
           return;
      }
      // --- End Filter Logic ---

      tasksToShow++;
      const li = document.createElement('li');
      li.className = 'task-item';
      li.setAttribute('data-task-id', task.id);

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `task-checkbox-${task.id}`;
      // Checkbox initial state should reflect if it *would* be completed (even though we filter out completed ones)
      // This seems redundant given the filter, but safer if filter logic changes. Let's keep it false.
      checkbox.checked = false;

      // **** CRITICAL: Use the globally exposed function ****
      checkbox.setAttribute('onclick', `toggleTaskDirect('${task.id}', '${dateKey}')`);

      const span = document.createElement('span');
      span.textContent = task.text;
      // No 'completed-task' class initially, as we are only showing non-completed tasks

      li.appendChild(checkbox);
      li.appendChild(span);

      if (task.repeat === 'daily') {
        const dailyBadge = document.createElement('span');
        dailyBadge.textContent = 'ðŸ”„ Daily'; // Use an icon/emoji
        dailyBadge.style.marginLeft = '8px';
        dailyBadge.style.fontSize = '0.8rem';
        dailyBadge.style.color = '#555';
        dailyBadge.style.backgroundColor = '#eee';
        dailyBadge.style.padding = '1px 4px';
        dailyBadge.style.borderRadius = '3px';
        dailyBadge.style.whiteSpace = 'nowrap';
        li.appendChild(dailyBadge);
      }

      // Add Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Ã—';
      deleteBtn.title = 'Delete Task Permanently';
      deleteBtn.style.marginLeft = 'auto'; // Push to the right
      deleteBtn.style.background = 'none';
      deleteBtn.style.border = 'none';
      deleteBtn.style.fontSize = '18px';
      deleteBtn.style.color = '#dc3545'; // Red color for delete
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.style.padding = '0 5px';
      // **** CRITICAL: Use the globally exposed function ****
      deleteBtn.setAttribute('onclick', `deleteTaskDirect('${task.id}')`);
      li.appendChild(deleteBtn);

      taskListContainer.appendChild(li);
    });

     if (tasksToShow === 0 && tasks.length > 0) {
        // If all tasks were filtered out (e.g., all completed)
        const allDoneMessage = document.createElement('p');
        allDoneMessage.textContent = 'All tasks in this list are complete for today!';
        allDoneMessage.style.color = 'green';
        allDoneMessage.style.fontStyle = 'italic';
        allDoneMessage.style.padding = '10px 0';
        taskListContainer.appendChild(allDoneMessage);
     }

    console.log(`Rendered ${tasksToShow} tasks.`);
  }


  function fixTaskButtons() {
    console.log("Running fixTaskButtons");
    const taskToggleContainer = document.querySelector('.task-toggle');
    if (!taskToggleContainer) {
      console.error("Task toggle container not found!");
      return;
    }

    // Clear existing buttons before rebuilding
    taskToggleContainer.innerHTML = '';

    // Function to create and append a button
    const createButton = (text, key) => {
        const button = document.createElement('button');
        button.textContent = text;
        button.setAttribute('onclick', `switchTaskDirect('${key}')`);
        // Set ID for default lists for easier selection
        if (key === 'personal' || key === 'work') {
            button.id = `${key}TasksBtn`;
        }
        taskToggleContainer.appendChild(button);
    };

    // Add default buttons first
    createButton('Personal Tasks', 'personal');
    createButton('Work Tasks', 'work');

    // Add buttons for custom lists, ensuring they are valid keys
    Object.keys(taskLists).forEach(listKey => {
        if (listKey !== 'personal' && listKey !== 'work' && typeof listKey === 'string' && listKey.trim() !== '') {
            // Convert key back to display name (simple capitalization, replace hyphens)
            const displayName = listKey.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            createButton(displayName, listKey);
        }
    });


    // --- Static Action Buttons ---
    const addTaskBtn = document.querySelector('.add-task-btn');
    if (addTaskBtn) {
      addTaskBtn.setAttribute('onclick', 'addTaskDirect()');
      // console.log("Add Task button onclick set.");
    } else {
      console.error("Add Task button not found!");
    }

    const newListBtn = document.querySelector('.new-list-btn');
    if (newListBtn) {
      newListBtn.setAttribute('onclick', 'createNewListDirect()');
      // console.log("New List button onclick set.");
    } else {
        console.error("New List button not found!");
    }

    const deleteListBtn = document.querySelector('.delete-list-btn');
    if (deleteListBtn) {
      deleteListBtn.setAttribute('onclick', 'deleteCurrentListDirect()');
      // console.log("Delete List button onclick set.");
      // Initial visibility is handled by switchTaskDirect
    } else {
        console.error("Delete List button not found!");
    }
  }


  function toggleTaskDirect(taskId, dateKey) {
    console.log(`Toggle task called: ID=${taskId}, List=${currentTaskList}, Date=${dateKey}`);
    if (!taskLists[currentTaskList]) {
      console.error("Current task list doesn't exist:", currentTaskList);
      return;
    }

    const tasks = taskLists[currentTaskList];
    const taskIndex = tasks.findIndex(t => t && t.id == taskId); // Use == for type flexibility, check task exists

    if (taskIndex === -1) {
      console.error(`Task not found: ID=${taskId} in list "${currentTaskList}"`);
      // Maybe the task was deleted in another session? Re-render to be safe.
      renderTasks();
      return;
    }

    const task = tasks[taskIndex];
    const taskElement = document.querySelector(`.task-item[data-task-id="${taskId}"]`);

    if (!task) {
        console.error("Found index but task object is invalid:", taskIndex, tasks);
        return;
    }

    let isNowCompleted = false;

    if (task.repeat === 'once') {
      task.completed = !task.completed;
      isNowCompleted = task.completed;
      console.log(`Task ${taskId} (${task.text}) 'once' completion toggled to: ${isNowCompleted}`);

    } else if (task.repeat === 'daily') {
      if (!task.completions) task.completions = {}; // Initialize if missing
      task.completions[dateKey] = !task.completions[dateKey]; // Toggle for the specific date
      isNowCompleted = task.completions[dateKey];
      console.log(`Task ${taskId} (${task.text}) 'daily' completion for ${dateKey} toggled to: ${isNowCompleted}`);

    } else {
        console.warn("Task has invalid 'repeat' property:", task);
        return; // Don't proceed if repeat type is unknown
    }

    saveUserData(); // Save the change immediately

    // --- UI Update ---
    if (taskElement) {
        if (isNowCompleted) {
            // Apply fade-out effect and then remove by re-rendering
            console.log("Fading out task element:", taskId);
            taskElement.style.transition = 'opacity 0.5s ease-out';
            taskElement.style.opacity = '0';
            // Use setTimeout to allow fade animation before re-rendering the list
            setTimeout(() => {
                console.log("Re-rendering tasks after fade out for:", taskId);
                renderTasks();
            }, 500); // Match CSS transition duration
        } else {
            // If unchecking (shouldn't happen with current render logic, but future-proof)
            // Ensure style is correct if it was somehow rendered while completed
            const span = taskElement.querySelector('span');
            if (span) span.classList.remove('completed-task');
            taskElement.style.opacity = '1'; // Ensure visible
            const checkbox = taskElement.querySelector('input[type="checkbox"]');
            if(checkbox) checkbox.checked = false;
        }
    } else {
        // If the element wasn't found (e.g., already faded out or race condition)
        // just re-render the list to ensure consistency.
        console.warn("Task element not found for UI update, re-rendering list.");
        renderTasks();
    }
  }


  function deleteTaskDirect(taskId) {
    console.log(`Delete task called: ID=${taskId}, List=${currentTaskList}`);
    if (!taskLists[currentTaskList]) {
       console.error("Cannot delete task, current list invalid:", currentTaskList);
       return;
    }

    const taskIndex = taskLists[currentTaskList].findIndex(t => t && t.id == taskId);

    if (taskIndex !== -1) {
      const taskText = taskLists[currentTaskList][taskIndex].text;
      // Optional: Confirmation dialog
      if (confirm(`Are you sure you want to permanently delete task: "${taskText}"?`)) {
          taskLists[currentTaskList].splice(taskIndex, 1); // Remove the task
          console.log(`Task ${taskId} (${taskText}) removed from list ${currentTaskList}`);
          saveUserData(); // Save the change
          renderTasks(); // Re-render the list immediately
      } else {
          console.log("Task deletion cancelled by user.");
      }
    } else {
      console.warn(`Task ${taskId} not found in list ${currentTaskList} for deletion.`);
      // Maybe it was already deleted? Re-render for consistency.
      renderTasks();
    }
  }


  function switchTaskDirect(type) {
    console.log("Switching task list to:", type);

    // Ensure the target list type is valid and exists
    if (typeof type !== 'string' || type.trim() === '') {
        console.error("Invalid task list type provided:", type);
        return;
    }
    if (!taskLists[type]) {
        console.warn(`Task list "${type}" does not exist in data. Creating it.`);
        taskLists[type] = [];
        // We need to update the buttons if a list was just created dynamically
        fixTaskButtons();
    }

    currentTaskList = type; // Update the global state

    // --- Update Active Button Styling ---
    document.querySelectorAll('.task-toggle button').forEach(btn => {
      const btnOnClick = btn.getAttribute('onclick');
      // Check if the onclick attribute contains the exact function call for this type
      const isActive = btnOnClick && btnOnClick.includes(`switchTaskDirect('${type}')`);
      if (isActive) {
        btn.classList.add('active');
        // console.log("Activated button:", btn.textContent);
      } else {
        btn.classList.remove('active');
      }
    });

    // --- Show/Hide Delete Button ---
    const deleteListBtn = document.querySelector('.delete-list-btn');
    if (deleteListBtn) {
        if (currentTaskList === 'personal' || currentTaskList === 'work') {
            deleteListBtn.style.display = 'none'; // Hide for default lists
        } else {
            deleteListBtn.style.display = 'inline-block'; // Show for custom lists
        }
    }

    renderTasks(); // Render the tasks for the newly selected list
  }


  function addTaskDirect() {
    console.log("Add task called directly for list:", currentTaskList);
    const taskInput = document.getElementById('taskInput');
    const dailyCheckbox = document.getElementById('taskDailyCheckbox');
    if (!taskInput || !dailyCheckbox) {
        console.error("Task input or checkbox element not found!");
        return;
    }

    const rawText = taskInput.value.trim();
    if (!rawText) {
      alert("Please enter a task description.");
      return;
    }

    const tasksTexts = rawText.split(',') // Split by comma for multiple tasks
                              .map(t => t.trim()) // Trim whitespace
                              .filter(Boolean); // Remove empty strings

    if (tasksTexts.length === 0) {
         alert("Please enter valid task descriptions.");
         return;
    }

    const isDaily = dailyCheckbox.checked;

    // Ensure the current list exists
    if (!taskLists[currentTaskList]) {
      console.warn("Current task list was invalid, creating:", currentTaskList);
      taskLists[currentTaskList] = [];
       fixTaskButtons(); // Update buttons if list was just created
       switchTaskDirect(currentTaskList); // Ensure the new list is active
    }

    tasksTexts.forEach((text) => {
      const newTask = {
        text,
        id: Date.now() + Math.random(), // More robust unique ID
        repeat: isDaily ? 'daily' : 'once',
        createdAt: new Date().toISOString(), // Track creation time
      };

      if (newTask.repeat === 'daily') {
        newTask.completions = {}; // Initialize empty completions map
      } else {
        newTask.completed = false; // Initialize completion state
      }

      taskLists[currentTaskList].push(newTask);
      console.log("Added new task:", newTask);
    });

    taskInput.value = ''; // Clear input field
    dailyCheckbox.checked = false; // Reset checkbox

    saveUserData(); // Save the updated task list
    renderTasks(); // Re-render the list with the new task(s)
  }


  function createNewListDirect() {
    console.log("Create new list called directly");
    const listName = prompt("Enter a name for the new task list:");

    if (listName && listName.trim()) {
      const trimmedName = listName.trim();
      // Create a safe key (lowercase, hyphenated, alphanumeric only)
      const listKey = trimmedName.toLowerCase()
                                .replace(/\s+/g, '-') // Replace spaces with hyphens
                                .replace(/[^a-z0-9-]/g, ''); // Remove non-alphanumeric characters except hyphens

      if (!listKey) {
          alert("Invalid list name. Please use letters, numbers, or spaces.");
          return;
      }

      if (!taskLists[listKey]) {
        taskLists[listKey] = []; // Add the new list to our data
        console.log(`Created new task list: Name="${trimmedName}", Key="${listKey}"`);

        saveUserData(); // Save the new list structure

        // Update the UI - rebuild buttons and switch to the new list
        fixTaskButtons();
        switchTaskDirect(listKey);

      } else {
        alert(`A list with the name "${trimmedName}" (or key "${listKey}") already exists! Please choose a different name.`);
      }
    } else if (listName !== null) {
        alert("List name cannot be empty.");
    }
  }


  function deleteCurrentListDirect() {
    console.log("Delete current list called directly:", currentTaskList);

    // Prevent deletion of default lists
    if (currentTaskList === 'personal' || currentTaskList === 'work') {
      alert("The default 'Personal' and 'Work' lists cannot be deleted.");
      return;
    }

    // Find the display name for confirmation using the active button
    const currentButton = document.querySelector(`.task-toggle button.active`);
    const currentListName = currentButton ? currentButton.textContent : currentTaskList; // Fallback to key if button not found

    if (confirm(`Are you sure you want to permanently delete the task list "${currentListName}" and all tasks within it? This cannot be undone.`)) {

      // Remove the list data
      if (taskLists[currentTaskList]) {
            delete taskLists[currentTaskList];
            console.log("Deleted task list data for:", currentTaskList);

            saveUserData(); // Save the change

            // Switch back to the 'personal' list and update UI
            const listToSwitchTo = 'personal';
            currentTaskList = listToSwitchTo; // Set state before UI update
            fixTaskButtons(); // Rebuild buttons (removing the deleted one)
            switchTaskDirect(listToSwitchTo); // Activate 'personal' and render its tasks

      } else {
          console.warn("List data not found for deletion key:", currentTaskList);
           // Still try to reset UI
           const listToSwitchTo = 'personal';
           currentTaskList = listToSwitchTo;
           fixTaskButtons();
           switchTaskDirect(listToSwitchTo);
      }
    } else {
        console.log("List deletion cancelled.");
    }
  }

 /*******************************************************
   14) Habit Tracker Functions
  *******************************************************/

    function openHabitTracker(date) {
        const habitForm = document.getElementById('habitForm');
        const habitDateEl = document.getElementById('habitDate'); // Target the correct element
        const habitListEl = document.getElementById('habitList');

        if (!habitForm || !habitDateEl || !habitListEl) {
            console.error("Habit form elements not found!");
            return;
        }

        // Set date display
        const displayDate = new Date(date + 'T00:00:00');
        habitDateEl.textContent = displayDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        habitForm.dataset.date = date; // Store YYYY-MM-DD

        renderHabitList(date); // Render habits for the day

        // Make habit form visible and hide others
        document.getElementById('journalForm').style.display = 'none';
        document.getElementById('eventForm').style.display = 'none';
        document.getElementById('goalsForm').style.display = 'none';
        document.getElementById('newHabitForm').style.display = 'none'; // Ensure add form is hidden initially
        habitForm.style.display = 'block';

         // Show day navigation buttons
        document.getElementById('prevDayButton').style.display = 'block';
        document.getElementById('nextDayButton').style.display = 'block';

        console.log("Opened habit tracker for:", date);
    }

    function renderHabitList(date) {
        const habitListEl = document.getElementById('habitList');
        habitListEl.innerHTML = ''; // Clear previous list

        if (globalHabits.length === 0) {
            habitListEl.innerHTML = '<p style="color: #666; font-style: italic;">No habits defined yet. Click "Add Habit" to create one.</p>';
            return;
        }

        const dailyHabitData = habitTracker[date] || {}; // Get data for the specific date, or empty object

        globalHabits.forEach(habit => {
            const habitDiv = document.createElement('div');
            habitDiv.style.padding = '10px 0';
            habitDiv.style.borderBottom = '1px solid #eee';
            habitDiv.style.display = 'flex';
            habitDiv.style.alignItems = 'center';
            habitDiv.style.gap = '10px';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = habit.name;
            nameSpan.style.flexGrow = '1'; // Take available space

            habitDiv.appendChild(nameSpan);

            const currentValue = dailyHabitData[habit.id]; // Get value for this specific habit on this day

            if (habit.type === 'check') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !!currentValue; // Treat any truthy value as checked
                checkbox.onchange = (e) => updateHabitValue(date, habit.id, e.target.checked);
                habitDiv.appendChild(checkbox);
            } else if (habit.type === 'count') {
                const countInput = document.createElement('input');
                countInput.type = 'number';
                countInput.min = '0';
                countInput.value = currentValue || 0; // Default to 0 if no value
                countInput.style.width = '60px';
                countInput.style.padding = '5px';
                countInput.style.textAlign = 'center';
                countInput.onchange = (e) => updateHabitValue(date, habit.id, parseInt(e.target.value) || 0); // Ensure number
                habitDiv.appendChild(countInput);
            }

             // Add delete button for the global habit
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Ã—';
            deleteBtn.title = 'Delete this habit entirely';
            deleteBtn.style.background = 'none';
            deleteBtn.style.border = '1px solid #ccc';
            deleteBtn.style.borderRadius = '50%';
            deleteBtn.style.color = '#dc3545';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.padding = '0px 5px';
            deleteBtn.style.fontSize = '14px';
            deleteBtn.style.lineHeight = '1';
            deleteBtn.onclick = () => deleteGlobalHabit(habit.id);
            habitDiv.appendChild(deleteBtn);


            habitListEl.appendChild(habitDiv);
        });
    }

    function updateHabitValue(date, habitId, value) {
        if (!habitTracker[date]) {
            habitTracker[date] = {}; // Create entry for the date if it doesn't exist
        }
        habitTracker[date][habitId] = value;
        console.log(`Updated habit ${habitId} for ${date} to: ${value}`);
        // Debounce saving? For now, save immediately.
        // saveUserData(); // Save changes (will be saved when 'Save Habits' is clicked)
    }

     function showNewHabitForm() {
        document.getElementById('newHabitForm').style.display = 'block';
        document.getElementById('newHabitName').value = ''; // Clear input
        document.querySelector('input[name="habitType"][value="count"]').checked = true; // Default to count
    }

    function cancelAddHabit() {
        document.getElementById('newHabitForm').style.display = 'none';
    }

    function confirmAddHabit() {
        const nameInput = document.getElementById('newHabitName');
        const name = nameInput.value.trim();
        const type = document.querySelector('input[name="habitType"]:checked').value;

        if (!name) {
            alert("Please enter a name for the habit.");
            return;
        }

        // Check if habit name already exists
        if (globalHabits.some(h => h.name.toLowerCase() === name.toLowerCase())) {
            alert(`A habit named "${name}" already exists.`);
            return;
        }

        const newHabit = {
            id: 'habit_' + Date.now(), // Unique ID
            name: name,
            type: type
        };

        globalHabits.push(newHabit);
        console.log("Added new global habit:", newHabit);

        // Hide the form and re-render the list
        document.getElementById('newHabitForm').style.display = 'none';
        const currentDate = document.getElementById('habitForm').dataset.date;
        if (currentDate) {
            renderHabitList(currentDate);
        }

        // Save immediately? Or wait for main save button? Let's wait.
        // saveUserData();
    }

     function deleteGlobalHabit(habitId) {
        const habitToDelete = globalHabits.find(h => h.id === habitId);
        if (!habitToDelete) return;

        if (confirm(`Are you sure you want to delete the habit "${habitToDelete.name}" entirely? This will remove it from all past and future dates.`)) {
            // Remove from global list
            globalHabits = globalHabits.filter(h => h.id !== habitId);

            // Remove from all tracked dates (optional, could keep history)
            // Uncomment if you want to clear history:
            // Object.keys(habitTracker).forEach(date => {
            //     if (habitTracker[date][habitId] !== undefined) {
            //         delete habitTracker[date][habitId];
            //         // If the date object becomes empty, remove it?
            //         if (Object.keys(habitTracker[date]).length === 0) {
            //             delete habitTracker[date];
            //         }
            //     }
            // });

            console.log(`Deleted global habit: ${habitToDelete.name} (ID: ${habitId})`);

            // Re-render the current list
            const currentDate = document.getElementById('habitForm').dataset.date;
            if (currentDate) {
                renderHabitList(currentDate);
            }
             // Save changes (wait for main save button?)
            // saveUserData();
        }
    }

    function saveHabitTracker() {
        // The updates happened in updateHabitValue and confirmAddHabit/deleteGlobalHabit
        // This button just triggers the save of the current state
        console.log("Saving habit tracker data...");
        saveUserData(); // Saves globalHabits and habitTracker
        closeHabitForm(); // Close and return to journal view
        generateCalendar(); // Update habit indicators on calendar
    }


  /*******************************************************
   15) Initialization & Global Exposure
  *******************************************************/

  // --- Auth State Change Listener ---
  onAuthStateChanged(auth, async (user) => {
    const authSection = document.getElementById('authSection');
    const logoutSection = document.getElementById('logoutSection');
    const calendarContainer = document.querySelector('.calendar-container'); // Show/hide whole calendar

    if (user) {
      userId = user.uid;
      console.log("Auth state changed: User logged in", userId);
      authSection.style.display = 'none';
      logoutSection.style.display = 'block';
      calendarContainer.style.display = 'block'; // Show calendar

      await loadUserData(); // Wait for data to load

      // Initial setup after load
      fixTaskButtons(); // Build task toggle buttons (incl. custom)
      generateCalendar(); // Generate calendar display

      // Set the initial task list view correctly
      if (!taskLists[currentTaskList] || !currentTaskList) {
          console.log("Resetting currentTaskList to 'personal' after load.");
          currentTaskList = 'personal'; // Default to 'personal' if state is invalid
      }
       // Don't call renderTasks directly here, openJournal or initial view will handle it.
      // Switch to the default/last task list to set active button etc.
      switchTaskDirect(currentTaskList);


      console.log("User logged in, data loaded, UI initialized.");

    } else {
      userId = null;
      console.log("Auth state changed: User logged out");
      authSection.style.display = 'block';
      logoutSection.style.display = 'none';
      calendarContainer.style.display = 'none'; // Hide calendar

       // Close any open forms
       closeJournalForm();
       closeEventForm();
       closeHabitForm();
       closeGoalsForm();


      // Clear local data on logout
      events = [];
      journalEntries = {};
      taskLists = { personal: [], work: [] }; // Reset to defaults
      currentTaskList = 'personal';
      habitTracker = {};
      globalHabits = [];
      userGoals = '';
      if(document.getElementById('goalsText')) document.getElementById('goalsText').value = '';
      if(document.getElementById('taskList')) document.getElementById('taskList').innerHTML = ''; // Clear task list UI

      // Optionally clear calendar grid or just hide the container
       const calendarGrid = document.querySelector('.calendar-grid');
       if (calendarGrid) {
           const headers = calendarGrid.querySelectorAll('.day-header');
           calendarGrid.innerHTML = '';
           headers.forEach(header => calendarGrid.appendChild(header.cloneNode(true)));
       }


      console.log("User logged out, local data cleared, UI reset.");
    }
  });

  // --- Expose functions needed by HTML onclick attributes ---
  function initializeGlobalFunctions() {
    window.loginWithGoogle = loginWithGoogle;
    window.logoutFromGoogle = logoutFromGoogle;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.openJournal = openJournal;
    window.closeJournalForm = closeJournalForm;
    window.changeJournalDay = changeJournalDay;
    window.addEvent = addEvent;
    window.editEvent = editEvent; // Ensure editEvent is exposed if used by onclick
    window.saveEvent = saveEvent;
    window.closeEventForm = closeEventForm;
    window.deleteEvent = deleteEvent;
    window.saveJournal = saveJournal;
    window.goToGoalsPage = goToGoalsPage;
    window.saveGoals = saveGoals;
    window.closeGoalsForm = closeGoalsForm;
    window.goToJournalFromGoals = goToJournalFromGoals;

    // Task functions
    window.toggleTaskDirect = toggleTaskDirect;
    window.deleteTaskDirect = deleteTaskDirect;
    window.switchTaskDirect = switchTaskDirect;
    window.addTaskDirect = addTaskDirect;
    window.createNewListDirect = createNewListDirect;
    window.deleteCurrentListDirect = deleteCurrentListDirect;

    // Habit functions
    window.changeToHabit = changeToHabit;
    window.changeToJournal = changeToJournal;
     window.openHabitTracker = openHabitTracker; // Expose if needed directly
    window.showNewHabitForm = showNewHabitForm;
    window.confirmAddHabit = confirmAddHabit;
    window.cancelAddHabit = cancelAddHabit;
    window.saveHabitTracker = saveHabitTracker;
    // window.cancelHabitTracker is aliased to closeHabitForm above


    console.log("Global functions initialized.");
  }

  // --- Initial Setup on Script Load ---
  initializeGlobalFunctions(); // Make functions available to HTML
  // generateCalendar(); // Generate calendar on initial load (will be regenerated on login)
  // Initial task button setup and rendering happens within onAuthStateChanged after login


</script>

</body>
</html>
