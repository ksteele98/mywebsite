<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar App (Google Auth)</title>

  <style>
    /* === Your existing CSS unchanged === */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .calendar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #ddd;
    }
    .calendar-cell {
      background-color: white;
      min-height: 100px;
      padding: 10px;
      cursor: pointer;
      user-select: none;
      overflow: hidden;
    }
    .day-header {
      background-color: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    .date-number {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .event {
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      margin-bottom: 2px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .nav-button {
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 8px 16px;
      cursor: pointer;
      width: auto;
      min-width: 100px;
    }
    .current-month {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }
    .event-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 300px;
      z-index: 1000;
    }
    .event-form input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .event-form h3 {
      margin-top: 0;
      margin-bottom: 15px;
    }
    .color-picker {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(25px, 1fr));
      gap: 5px;
      margin: 10px 0;
    }
    .color-option {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .color-option.selected {
      border: 2px solid #000;
    }
    .time-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .time-inputs div {
      flex: 1;
      min-width: 120px;
    }
    .time-inputs label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .event-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .event-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 80px;
    }
    .event-actions button:first-child {
      background: #4285f4;
      color: white;
    }
    .event-actions button:last-child {
      background: #ddd;
    }
    .delete-event-btn {
      background: #dc3545 !important;
      color: white;
    }
    .journal-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .journal-textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      resize: vertical;
      box-sizing: border-box;
    }
    .other-month {
      background-color: #f5f5f5;
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
      position: relative;
    }
    .task-item {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
      gap: 5px;
      transition: opacity 5s ease;
      opacity: 1;
    }
    .task-item.fade-out {
      opacity: 0;
    }
    .task-item input[type="checkbox"] {
      margin-right: 10px;
    }
    .task-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .add-task-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      width: 100%;
    }
    .completed-task {
      text-decoration: line-through;
      color: #888;
    }
    .task-container {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      position: relative;
    }
    .task-toggle {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .task-toggle button {
      flex: 1;
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 4px;
      min-width: 120px;
    }
    .task-toggle button.active {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }
    .daily-events {
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .daily-events h4 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .add-event-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    .new-list-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
      min-width: auto;
      flex: 0;
    }
    .delete-list-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: auto;
      flex: 0;
    }
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .change-habit-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .habit-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    #habitDate {
      margin-bottom: 10px;
    }
    .new-habit-form {
      margin-top: 20px;
      display: none; 
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }
    .new-habit-form h4 {
      margin-top: 0;
    }
    .habit-type-options label {
      margin-right: 10px;
    }
    .goals-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .audio-section button {
      padding: 6px 12px;
      margin-right: 10px;
    }
    .audio-section input[type="file"] {
      display: inline-block;
    }

    .image-section img {
      max-width: 100%;
      margin: 10px 0;
      display: block;
    }

    @media screen and (max-width: 768px) {
      .calendar-grid {
        font-size: 14px;
      }
      .calendar-cell {
        min-height: 80px;
        padding: 5px;
      }
      .event {
        font-size: 10px;
        padding: 1px 3px;
      }
      .current-month {
        font-size: 16px;
        width: 100%;
        text-align: center;
        order: -1;
      }
      .nav-button {
        padding: 6px 12px;
        min-width: auto;
        flex: 1;
      }
      .journal-form button {
        margin-bottom: 20px;
        padding: 12px;
        font-size: 16px;
      }
    }
    @media screen and (max-width: 480px) {
      body {
        padding: 10px;
      }
      .calendar-cell {
        min-height: 60px;
      }
      .day-header {
        padding: 5px;
        font-size: 12px;
      }
      .date-number {
        font-size: 12px;
      }
      .event {
        margin-bottom: 1px;
      }
      .event-form, .journal-form {
        width: 95%;
        padding: 15px;
      }
      .time-inputs div {
        flex: 100%;
      }
      .task-toggle button {
        flex: 100%;
      }
      .journal-form button {
        margin-bottom: 20px;
        padding: 12px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

<!-- A simple section to show/hide when not logged in -->
<div id="authSection" style="display: none; text-align:center; margin-bottom: 20px;">
  <button onclick="loginWithGoogle()" style="background: #DB4437; color:white; padding: 10px 20px; border:none; border-radius:4px; cursor:pointer;">
    Sign in with Google
  </button>
</div>

<!-- Add logout button that shows when logged in -->
<div id="logoutSection" style="display: none; text-align:right; margin-bottom: 20px;">
  <button onclick="openJournalMode()" id="journalModeBtn" style="background: #4285F4; color:white; padding: 8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right: 10px;">
    Journal Mode
  </button>
  <button onclick="logoutFromGoogle()" id="logoutButton" style="background: #4285F4; color:white; padding: 8px 16px; border:none; border-radius:4px; cursor:pointer;">
    Sign Out
  </button>
</div>

<div class="calendar-container">
  <div class="calendar-header">
    <button class="nav-button" onclick="previousMonth()">&lt; Previous</button>
    <div class="current-month"></div>
    <button class="nav-button" onclick="nextMonth()">Next &gt;</button>
  </div>
  <div class="calendar-grid">
    <div class="day-header">Sun</div>
    <div class="day-header">Mon</div>
    <div class="day-header">Tue</div>
    <div class="day-header">Wed</div>
    <div class="day-header">Thu</div>
    <div class="day-header">Fri</div>
    <div class="day-header">Sat</div>
  </div>
</div>

<!-- Event Form -->
<div class="event-form" id="eventForm">
  <h3>Add Event</h3>
  <input type="text" id="eventDescription" placeholder="Event Name" required>
  <div class="time-inputs">
    <div>
      <label for="eventStartTime">Start Time:</label>
      <input type="time" id="eventStartTime" required>
    </div>
    <div>
      <label for="eventEndTime">End Time:</label>
      <input type="time" id="eventEndTime" required>
    </div>
  </div>
  <h4>Select Color:</h4>
  <div class="color-picker" id="colorPicker"></div>
  <input type="hidden" id="eventDate">
  <input type="hidden" id="eventId">
  <div class="event-actions">
    <button onclick="saveEvent()">Save Event</button>
    <button onclick="closeEventForm()">Cancel</button>
    <button onclick="deleteEvent()" class="delete-event-btn">Delete</button>
  </div>
</div>

<!-- Journal Form -->
<div class="journal-form" id="journalForm">
  <button class="goals-btn" onclick="goToGoalsPage()">Go To Goals</button>
  <button class="change-habit-btn" onclick="changeToHabit()">Change to Habit</button>
  <h3>Daily Overview</h3>
  <div id="journalDate" style="margin-bottom: 10px;"></div>

  <div class="daily-events">
    <h4>Events</h4>
    <div id="dailyEventsList"></div>
    <button class="add-event-btn" onclick="addEvent(document.getElementById('journalForm').dataset.date)">Add Event</button>
  </div>

  <h4>Journal Entry</h4>
  <textarea id="journalText" class="journal-textarea" placeholder="Write your thoughts for this day..."></textarea>

  <div class="audio-section">
    <audio id="audioPlayer" controls style="display:none; width:100%; margin:10px 0;"></audio>
    <div style="margin-bottom:10px;">
      <button id="recordAudioBtn" onclick="toggleRecording()">Start Recording</button>
      <input type="file" id="audioFileInput" accept="audio/*" onchange="handleAudioUpload(event)" style="margin-left:10px;">
    </div>
  </div>

  <div class="image-section">
    <img id="imagePreview" style="display:none; width:100%; margin:10px 0;" />
    <input type="file" id="imageFileInput" accept="image/*" onchange="handleImageUpload(event)">
  </div>

  <div class="task-container">
    <div class="tasks-header">
      <h3>Tasks</h3>
      <div>
        <button class="new-list-btn" onclick="createNewList()">+ New List</button>
        <button class="delete-list-btn" onclick="deleteCurrentList()">Delete List</button>
      </div>
    </div>
    <div class="task-toggle">
      <button onclick="switchTaskList('personal')" id="personalTasksBtn" class="active">Personal Tasks</button>
      <button onclick="switchTaskList('work')" id="workTasksBtn">Work Tasks</button>
    </div>
            
    <label style="display: block; margin: 8px 0; font-size: 14px;">
      <input type="checkbox" id="taskDailyCheckbox" style="margin-right: 6px;">
      Repeat Daily?
    </label>

    <input type="text" id="taskInput" class="task-input" placeholder="Add a new task">
    <button class="add-task-btn" onclick="addTask()">Add Task</button>
    <ul class="task-list" id="taskList"></ul>
  </div>

  <button onclick="saveJournal()">Save</button>
  <button onclick="closeJournalForm()">Cancel</button>
</div>

<!-- Prev / Next Journal Buttons -->
<button id="prevDayButton" 
  class="nav-button" 
  style="position:fixed; left:20px; top:50%; transform:translateY(-50%); z-index:1001; display:none;" 
  onclick="changeJournalDay(-1)">&lt;</button>

<button id="nextDayButton" 
  class="nav-button" 
  style="position:fixed; right:20px; top:50%; transform:translateY(-50%); z-index:1001; display:none;" 
  onclick="changeJournalDay(1)">&gt;</button>

<!-- Habit Form -->
<div class="habit-form" id="habitForm" style="display: none;" data-date="">
  <div id="habitDate" style="margin-bottom: 10px;"></div>
  <button class="change-habit-btn" onclick="changeToJournal()">Change to Journal</button>
  <h3>Habit Tracker</h3>
  <div id="habitList"></div>
  <button onclick="showNewHabitForm()">Add Habit</button>
  <button onclick="saveHabitTracker()">Save</button>
  <button onclick="cancelHabitTracker()">Cancel</button>

  <div class="new-habit-form" id="newHabitForm">
    <h4>Add a New Habit</h4>
    <input type="text" id="newHabitName" placeholder="Habit Name">
    <div class="habit-type-options">
      <label><input type="radio" name="habitType" value="count" checked> Count</label>
      <label><input type="radio" name="habitType" value="check"> Check</label>
    </div>
    <button onclick="confirmAddHabit()">Save New Habit</button>
    <button onclick="cancelAddHabit()">Cancel</button>
  </div>
</div>

<!-- Goals Form -->
<div class="goals-form" id="goalsForm" style="display: none; position: fixed; top: 50%; left: 50%;
transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; 
box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; z-index: 1000;">
  <button onclick="goToJournalFromGoals()" 
    style="position: absolute; top: 10px; right: 10px; background:#4285f4; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
    Go to Journal
  </button>
  <h3>Goals</h3>
  <p>Write your goals here...</p>
  <textarea id="goalsText" style="width:100%; height:100px;" placeholder="Your goals..."></textarea>
  <div style="display: flex; gap: 10px; margin-top: 20px;">
    <button onclick="saveGoals()" style="flex:1; background:#4285f4; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">
      Save
    </button>
    <button onclick="closeGoalsForm()" style="flex:1; background:#ddd; border:none; padding:10px; border-radius:4px; cursor:pointer;">
      Cancel
    </button>
  </div>
</div>

<!-- ====================== Firebase + App Script ====================== -->
<script>
  // Create global function that will call the internal module function
  function logoutFromGoogle() {
    // This will be defined by the module script
    window._logoutFromGoogle && window._logoutFromGoogle();
  }
  
  function loginWithGoogle() {
    window._loginWithGoogle && window._loginWithGoogle();
  }

  function changeToHabit() {
    window._changeToHabit && window._changeToHabit();
  }
  
  function changeToJournal() {
    window._changeToJournal && window._changeToJournal();
  }
  
  function showNewHabitForm() {
    window._showNewHabitForm && window._showNewHabitForm();
  }
  
  function confirmAddHabit() {
    window._confirmAddHabit && window._confirmAddHabit();
  }
  
  function cancelAddHabit() {
    window._cancelAddHabit && window._cancelAddHabit();
  }
  
  function saveHabitTracker() {
    window._saveHabitTracker && window._saveHabitTracker();
  }
  
  function cancelHabitTracker() {
    window._cancelHabitTracker && window._cancelHabitTracker();
  }
</script>

<script type="module">
  /********************** 
    1) Firebase Imports
  ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

  /********************** 
    2) Firebase Config 
       (from your snippet)
  ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyCmtc69JDgCWtxPNgPU73Y4n7-asl6M72w",
    authDomain: "my-website-5dfa1.firebaseapp.com",
    projectId: "my-website-5dfa1",
    storageBucket: "my-website-5dfa1.appspot.com",
    messagingSenderId: "36790147861",
    appId: "1:36790147861:web:6391e58fe3193c4fabe71c",
    measurementId: "G-SSJEV8WQFT"
  };

  /********************** 
    3) Init Firebase
  ***********************/
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const storage = getStorage(app);

  let userId = null;  // will store current Google user's uid here
  const provider = new GoogleAuthProvider();

  // This function triggers the Google popup
  async function _loginWithGoogle() {
    try {
      const result = await signInWithPopup(auth, provider);
      // If successful, user is now signed in
      console.log("Google sign-in success!");
      // userId is set via onAuthStateChanged below
    } catch (error) {
      console.error("Google Sign-In Error:", error);
    }
  }

  // On page load, watch for auth changes
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      // Hide sign in button, show logout button
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('logoutSection').style.display = 'block';
      // Load data from Firestore
      await loadUserData();
      // Generate calendar, tasks, etc.
      generateCalendar();
      renderTasks();
    } else {
      // Show sign in button, hide logout button
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('logoutSection').style.display = 'none';
    }
  });

  // Update the logout function to store on window
  async function _logoutFromGoogle() {
    try {
      await signOut(auth);
      console.log("User signed out successfully");
      // Clear local data
      events = [];
      journalEntries = {};
      journalAudios = {};
      journalImages = {};
      taskLists = { personal: [], work: [] };
      habitTracker = {};
      globalHabits = [];
      // Regenerate calendar with cleared data
      generateCalendar();
    } catch (error) {
      console.error("Error signing out:", error);
    }
  }

  // Store the internal function on window
  window._logoutFromGoogle = _logoutFromGoogle;
  window._loginWithGoogle = _loginWithGoogle;

  /******************************************************* 
   4) In-Memory Data
  *******************************************************/
  let currentDate   = new Date();
  let events        = [];
  let selectedColor = '#4285f4';
  let journalEntries = {};
  let taskLists     = { personal: [], work: [] };
  let currentTaskList = 'personal';

  let habitTracker = {};
  let globalHabits = [];
  let journalAudios = {};
  let journalImages = {};
  let pendingAudioFile = null;
  let pendingImageFile = null;
  let mediaRecorder = null;
  let recordedChunks = [];

  // journal navigation mode
  let journalMode = false;
  let journalEntryDates = [];
  let journalEntryIndex = 0;

  /******************************************************* 
   5) Firestore Load/Save 
  *******************************************************/
  async function loadUserData() {
    if (!userId) return;
    try {
      const docRef = doc(db, "users", userId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        events          = data.events          || [];
        journalEntries  = data.journalEntries  || {};
        journalAudios   = data.journalAudios   || {};
        journalImages   = data.journalImages   || {};
        taskLists       = data.taskLists       || { personal: [], work: [] };
        habitTracker    = data.habitTracker    || {};
        globalHabits    = data.globalHabits    || [];
        document.getElementById('goalsText').value = data.userGoals || '';
        
        // Initialize task controls after loading data
        setTimeout(initializeTaskControls, 100);
      } else {
        console.log("No existing Firestore doc for this user; starting fresh.");
        taskLists = { personal: [], work: [] };
        setTimeout(initializeTaskControls, 100);
      }
    } catch (err) {
      console.error("Error loading user data:", err);
    }
  }

  async function saveUserData() {
    if (!userId) return; // not signed in yet
    try {
      const docRef = doc(db, "users", userId);
      await setDoc(docRef, {
        events,
        journalEntries,
        journalAudios,
        journalImages,
        taskLists,
        habitTracker,
        globalHabits,
        userGoals: document.getElementById('goalsText')?.value || ''
      });
      console.log("Data saved to Firestore!");
    } catch (err) {
      console.error("Error saving user data:", err);
    }
  }

  /******************************************************* 
   6) Color Picker
  *******************************************************/
  const colors = [
    '#FF0000','#FF4500','#FF6B6B','#FFA500','#FFD700','#F1C40F','#FFEEAD',
    '#90EE90','#2ECC71','#27AE60','#16A085','#96CEB4','#4ECDC4',
    '#45B7D1','#3498DB','#2980B9','#0000FF','#8E44AD','#9B59B6','#D4A5A5'
  ];

  // ─── converts "13:05" ➜ "1:05 PM" ───
    function formatTime(timeStr) {
  const [hStr, m] = timeStr.split(":");
  let h = parseInt(hStr, 10);
  const ampm = h >= 12 ? "PM" : "AM";
  h = h % 12;
  if (h === 0) h = 12;
  return `${h}:${m} ${ampm}`;
}


function initializeColorPicker(preSelected = selectedColor) {
  const colorPicker = document.getElementById("colorPicker");
  colorPicker.innerHTML = "";
  colors.forEach(color => {
    const dot = document.createElement("div");
    dot.className = "color-option";
    dot.style.backgroundColor = color;
    if (color === preSelected) dot.classList.add("selected");
    dot.onclick = () => {
      document.querySelectorAll(".color-option")
              .forEach(o => o.classList.remove("selected"));
      dot.classList.add("selected");
      selectedColor = color;
    };
    colorPicker.appendChild(dot);
  });
}

  /******************************************************* 
   7) Calendar Navigation 
  *******************************************************/
  function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
  }

  /******************************************************* 
   8) Calendar Generation
  *******************************************************/
  function generateCalendar() {
    const monthYear = document.querySelector('.current-month');
    const headers = document.querySelectorAll('.day-header');
    const oldGrid = document.querySelector('.calendar-grid');
    oldGrid.innerHTML = '';
    headers.forEach(header => oldGrid.appendChild(header.cloneNode(true)));

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthNames = ["January","February","March","April","May","June",
                        "July","August","September","October","November","December"];
    monthYear.textContent = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay  = new Date(year, month + 1, 0);
    const firstDayIndex = firstDay.getDay();

    for (let i = firstDayIndex; i > 0; i--) {
      const prevDate = new Date(year, month, -i + 1);
      const cell = createCalendarCell(prevDate, true);
      oldGrid.appendChild(cell);
    }

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const date = new Date(year, month, day);
      const cell = createCalendarCell(date, false);
      oldGrid.appendChild(cell);
    }

    const remainingCells = 42 - (firstDayIndex + lastDay.getDate());
    for (let i = 1; i <= remainingCells; i++) {
      const nextDate = new Date(year, month + 1, i);
      const cell = createCalendarCell(nextDate, true);
      oldGrid.appendChild(cell);
    }
  }

  function createCalendarCell(date, isOtherMonth) {
    const cell = document.createElement('div');
    cell.className = `calendar-cell${isOtherMonth ? ' other-month' : ''}`;
    const dateNumber = document.createElement('div');
    dateNumber.className = 'date-number';
    dateNumber.textContent = date.getDate();
    cell.appendChild(dateNumber);

    const dateStr = date.toISOString().split('T')[0];
    cell.addEventListener('click', () => {
      openJournal(dateStr);
    });

    // Show events
    events.forEach((event) => {
      if (event.date === dateStr) {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.description;
        eventDiv.onclick = (e) => {
          e.stopPropagation();
          editEvent(event, events.indexOf(event));
        };
        cell.appendChild(eventDiv);
      }
    });

    // Show a small "Journal" tag if there's a journal entry
    if (journalEntries[dateStr]) {
      const journalIndicator = document.createElement('div');
      journalIndicator.className = 'event';
      journalIndicator.style.backgroundColor = '#666';
      journalIndicator.textContent = '📝 Journal Entry';
      cell.appendChild(journalIndicator);
    }

    return cell;
  }

  /******************************************************* 
   9) Open/Close Journal
  *******************************************************/
  function openJournal(date) {
    const journalForm = document.getElementById('journalForm');
    const journalDate = document.getElementById('journalDate');
    const journalText = document.getElementById('journalText');
    const audioPlayer = document.getElementById('audioPlayer');
    const recordBtn = document.getElementById('recordAudioBtn');
    const fileInput = document.getElementById('audioFileInput');
    const imagePreview = document.getElementById('imagePreview');
    const imageInput = document.getElementById('imageFileInput');

    pendingAudioFile = null;
    pendingImageFile = null;
    recordedChunks = [];
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
    recordBtn.textContent = 'Start Recording';
    fileInput.value = '';
    imageInput.value = '';

    const displayDate = new Date(date + 'T00:00:00');
    journalDate.textContent = displayDate.toLocaleDateString();
    journalText.value = journalEntries[date] || '';
    journalForm.dataset.date = date;
    journalForm.style.display = 'block';

    if (journalAudios[date]) {
      audioPlayer.src = journalAudios[date];
      audioPlayer.style.display = 'block';
    } else {
      audioPlayer.src = '';
      audioPlayer.style.display = 'none';
    }

    if (journalImages[date]) {
      imagePreview.src = journalImages[date];
      imagePreview.style.display = 'block';
    } else {
      imagePreview.src = '';
      imagePreview.style.display = 'none';
    }

    document.getElementById('prevDayButton').style.display = 'block';
    document.getElementById('nextDayButton').style.display = 'block';

    updateDailyEventsList(date);
    renderTasks(); // re-render tasks for this date
    initializeTaskControls(); // Initialize task controls each time the journal is opened
  }

  function openJournalMode() {
    journalEntryDates = Object.keys(journalEntries)
      .filter(d => journalEntries[d] && journalEntries[d].trim() !== '')
      .sort();
    if (journalEntryDates.length === 0) {
      alert('No journal entries to display.');
      return;
    }
    journalEntryIndex = journalEntryDates.length - 1; // most recent
    journalMode = true;
    document.querySelector('.calendar-container').style.display = 'none';
    openJournal(journalEntryDates[journalEntryIndex]);
  }

  function closeJournalForm() {
    document.getElementById('journalForm').style.display = 'none';
    document.getElementById('prevDayButton').style.display = 'none';
    document.getElementById('nextDayButton').style.display = 'none';
    if (journalMode) {
      document.querySelector('.calendar-container').style.display = 'block';
      journalMode = false;
    }
  }

  function changeJournalDay(direction) {
    if (journalMode) {
      if (journalEntryDates.length === 0) return;
      journalEntryIndex += direction;
      if (journalEntryIndex < 0) journalEntryIndex = 0;
      if (journalEntryIndex >= journalEntryDates.length) journalEntryIndex = journalEntryDates.length - 1;
      const newDateStr = journalEntryDates[journalEntryIndex];
      openJournal(newDateStr);
      return;
    }

    const journalForm = document.getElementById('journalForm');
    const currentDateStr = journalForm.dataset.date;
    if (!currentDateStr) return;

    const [year, month, day] = currentDateStr.split('-').map(Number);
    const currentDate = new Date(year, month - 1, day);
    currentDate.setDate(currentDate.getDate() + direction);

    const newDateStr = currentDate.toISOString().split('T')[0];
    openJournal(newDateStr);
  }

  /*******************************************************
   10) Audio Recording/Upload
  *******************************************************/
  async function toggleRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        document.getElementById('audioPlayer').src = url;
        document.getElementById('audioPlayer').style.display = 'block';
        pendingAudioFile = new File([blob], 'journal.webm', { type: 'audio/webm' });
        document.getElementById('recordAudioBtn').textContent = 'Start Recording';
      };
      mediaRecorder.start();
      document.getElementById('recordAudioBtn').textContent = 'Stop Recording';
    } catch (err) {
      console.error('Error accessing microphone:', err);
    }
  }

  function handleAudioUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    pendingAudioFile = file;
    const url = URL.createObjectURL(file);
    document.getElementById('audioPlayer').src = url;
    document.getElementById('audioPlayer').style.display = 'block';
  }

  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    pendingImageFile = file;
    const url = URL.createObjectURL(file);
    const preview = document.getElementById('imagePreview');
    preview.src = url;
    preview.style.display = 'block';
  }

  /*******************************************************
   10) Events
  *******************************************************/
  function addEvent(date) {
    const eventForm = document.getElementById('eventForm');
    document.getElementById('eventDate').value = date;
    document.getElementById('eventId').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventStartTime').value = '';
    document.getElementById('eventEndTime').value = '';
    eventForm.style.display = 'block';
    initializeColorPicker();
    document.querySelector('.delete-event-btn').style.display = 'none';
    eventForm.style.zIndex = '1002'; // above the journal form
  }

  function editEvent(event, index) {
    const eventForm = document.getElementById('eventForm');
    document.getElementById('eventDate').value = event.date;
    document.getElementById('eventStartTime').value = event.startTime;
    document.getElementById('eventEndTime').value = event.endTime;
    document.getElementById('eventDescription').value = event.description;
    document.getElementById('eventId').value = index;
    selectedColor = event.color;

    eventForm.style.display = 'block';
    initializeColorPicker();
    document.querySelector('.delete-event-btn').style.display = 'block';

    // Mark selected color
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(opt => {
      if (opt.style.backgroundColor === event.color) {
        opt.classList.add('selected');
      }
    });
    document.getElementById('journalForm').style.display = 'none';
  }

  function closeEventForm() {
    document.getElementById('eventForm').style.display = 'none';
    selectedColor = '#4285f4';
  }

  function saveEvent() {
    const date = document.getElementById('eventDate').value;
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const description = document.getElementById('eventDescription').value;
    const eventId = document.getElementById('eventId').value;

    if (!description || !startTime || !endTime) {
      alert('Please fill in all fields');
      return;
    }
    if (endTime <= startTime) {
      alert('End time must be after start time');
      return;
    }

    const eventData = { date, startTime, endTime, description, color: selectedColor };
    if (eventId !== '') {
      // Editing existing
      events[parseInt(eventId)] = eventData;
    } else {
      // New
      events.push(eventData);
    }
    saveUserData();

    closeEventForm();
    generateCalendar();
    updateDailyEventsList(date);
  }

  function deleteEvent() {
    const eventId = document.getElementById('eventId').value;
    if (eventId !== '') {
      events.splice(parseInt(eventId), 1);
      saveUserData();
      closeEventForm();
      generateCalendar();

      const date = document.getElementById('eventDate').value;
      updateDailyEventsList(date);
    }
  }

 function updateDailyEventsList(date) {
  const list = document.getElementById("dailyEventsList");
  list.innerHTML = "";

  const dayEvents = events
    .filter(ev => ev.date === date)
    .sort((a, b) => a.startTime.localeCompare(b.startTime));

  if (dayEvents.length === 0) {
    list.innerHTML = "<p>No events scheduled for this day.</p>";
    return;
  }

  dayEvents.forEach(ev => {
    const div = document.createElement("div");
    div.className = "event";
    div.style.backgroundColor = ev.color;
    div.style.margin = "5px 0";
    div.style.padding = "8px";
    div.textContent =
      `${formatTime(ev.startTime)} - ${formatTime(ev.endTime)}: ${ev.description}`;
    div.onclick = () => editEvent(ev, events.indexOf(ev));
    list.appendChild(div);
  });
}


  /******************************************************* 
   11) Journal
  *******************************************************/
  async function saveJournal() {
  const journalForm = document.getElementById('journalForm');
  const date        = journalForm.dataset.date;
  const text        = document.getElementById('journalText').value.trim();

  if (!userId) {
    alert('You need to sign in first.');       // early exit guard
    return;
  }

  try {
    /* ── 1. Stop a live recording, if any ── */
    if (mediaRecorder?.state === 'recording') {
      await new Promise(res => {
        mediaRecorder.addEventListener('stop', res, { once: true });
        mediaRecorder.stop();
      });
    }

    /* ── 2. Upload audio (unique name to avoid collisions) ── */
    if (pendingAudioFile) {
      const safeName  = `${Date.now()}-${pendingAudioFile.name}`;
      const storageRef = ref(
        storage,
        `journalAudio/${userId}/${date}/${safeName}`
      );

      const snap  = await uploadBytes(storageRef, pendingAudioFile);
      const url   = await getDownloadURL(snap.ref);
      journalAudios[date] = url;
      pendingAudioFile = null;
    }

    /* ── 3. Upload image (unique name as well) ── */
    if (pendingImageFile) {
      const safeName  = `${Date.now()}-${pendingImageFile.name}`;
      const storageRef = ref(
        storage,
        `journalImages/${userId}/${date}/${safeName}`
      );

      const snap  = await uploadBytes(storageRef, pendingImageFile);
      const url   = await getDownloadURL(snap.ref);
      journalImages[date] = url;
      pendingImageFile = null;
    }

    /* ── 4. Store text right away ── */
    journalEntries[date] = text;

    /* ── 5. Persist only the changed fields ── */
    await setDoc(
      doc(db, 'users', userId),
      {
        journalEntries,
        journalAudios,
        journalImages,
        userGoals: document.getElementById('goalsText')?.value || ''
      },
      { merge: true }
    );

    /* ── 6. Visual feedback ── */
    generateCalendar();
    updateDailyEventsList(date);
    closeJournalForm();
  } catch (err) {
    console.error('Error saving journal:', err);
    alert('Could not save your journal entry. Check the console for details.');
  }
}


  /******************************************************* 
   12) Goals
  *******************************************************/
  function goToGoalsPage() {
    closeJournalForm();
    document.getElementById('goalsForm').style.display = 'block';
  }

  function saveGoals() {
    // We store goals in userGoals field in Firestore doc
    saveUserData();
    closeGoalsForm();
  }

  function closeGoalsForm() {
    document.getElementById('goalsForm').style.display = 'none';
    document.getElementById('journalForm').style.display = 'none';
  }

  function goToJournalFromGoals() {
    document.getElementById('goalsForm').style.display = 'none';
    document.getElementById('journalForm').style.display = 'block';
    document.getElementById('prevDayButton').style.display = 'block';
    document.getElementById('nextDayButton').style.display = 'block';
  }

  /******************************************************* 
   13) Task Lists
  *******************************************************/
  function switchTaskList(type) {
    currentTaskList = type;
    
    // Update active button styling
    document.querySelectorAll('.task-toggle button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    const activeButton = document.querySelector(`.task-toggle button[onclick*="${type}"]`);
    if (activeButton) {
      activeButton.classList.add('active');
    }
    
    renderTasks();
  }

  function createNewList() {
  const name = prompt("Name for new list:");
  if (!name) return;
  const key = name.toLowerCase().replace(/\\s+/g, "-");
  if (taskLists[key]) return alert("That list already exists!");

  taskLists[key] = [];
  const btn = document.createElement("button");
  btn.textContent = name;
  btn.onclick = () => switchTaskList(key);
  document.querySelector(".task-toggle").appendChild(btn);

  saveUserData();
  switchTaskList(key);
}

function deleteCurrentList() {
  if (["personal", "work"].includes(currentTaskList)) {
    alert("Can't delete default lists");
    return;
  }
  if (!confirm("Delete this list?")) return;

  delete taskLists[currentTaskList];
  document
    .querySelectorAll(".task-toggle button")
    .forEach(b => {
      if (b.textContent.toLowerCase().replace(/\\s+/g, "-") === currentTaskList)
        b.remove();
    });

  currentTaskList = "personal";
  document.getElementById("personalTasksBtn").classList.add("active");
  saveUserData();
  renderTasks();
}

  function addTask() {
  const text = taskInput.value.trim();
  if (!text) return alert("Please enter a task");
  const parts = text.split(",").map(t => t.trim()).filter(Boolean);
  const daily = taskDailyCheckbox.checked;
  if (!taskLists[currentTaskList]) taskLists[currentTaskList] = [];

  parts.forEach((t, i) => {
    taskLists[currentTaskList].push({
      text: t,
      id: Date.now() + i,
      repeat: daily ? "daily" : "once",
      completed: false,
      completions: {}
    });
  });

  taskInput.value = "";
  taskDailyCheckbox.checked = false;
  saveUserData();
  renderTasks();
}
function renderTasks() {
  const taskList = document.getElementById('taskList');
  taskList.innerHTML = '';

  // ensure list exists
  if (!taskLists[currentTaskList]) taskLists[currentTaskList] = [];

  const tasks       = taskLists[currentTaskList];
  const journalForm = document.getElementById('journalForm');
  const dateKey     = journalForm.dataset.date || new Date().toISOString().split('T')[0];

  // ─── filter out completed tasks ───
  const visibleTasks = tasks.filter(t =>
    t.repeat === 'once'
      ? !t.completed
      : !(t.completions && t.completions[dateKey])
  );

  // show "all done" message
  if (visibleTasks.length === 0) {
    const msg = document.createElement('p');
    msg.textContent = 'All done! 🎉';
    msg.style.color = '#666';
    msg.style.fontStyle = 'italic';
    taskList.appendChild(msg);
    return;
  }

  // ─── build the <li>s ───
  visibleTasks.forEach(task => {
    const li = document.createElement('li');
    li.className = 'task-item';
    li.dataset.taskId = task.id;

    const checkbox = document.createElement('input');
    checkbox.type  = 'checkbox';
    checkbox.id    = `task-checkbox-${task.id}`;
    checkbox.checked =
      task.repeat === 'daily'
        ? task.completions && task.completions[dateKey]
        : task.completed;
    checkbox.onclick = () => toggleTask(task.id, dateKey);

    const span = document.createElement('span');
    span.textContent = task.text;

    if (task.repeat === 'daily') {
      const badge = document.createElement('span');
      badge.textContent = 'Repeat Daily';
      badge.style.cssText = 'margin-left:8px;font-size:0.85rem;color:#888;';
      li.appendChild(badge);
    }

    const del = document.createElement('button');
    del.textContent = '×';
    del.style.cssText =
      'margin-left:auto;background:none;border:none;font-size:18px;cursor:pointer;color:#dc3545;';
    del.onclick = () => deleteTask(task.id);

    li.append(checkbox, span, del);
    taskList.appendChild(li);
  });
}

// Use these internal functions for event handling
function toggleTask(taskId, dateKey) {
  const tasks = taskLists[currentTaskList];
  const task  = tasks.find(t => t.id == taskId);
  if (!task) return;

  // flip the flag
  if (task.repeat === 'once') {
    task.completed = !task.completed;
  } else {
    task.completions = task.completions || {};
    task.completions[dateKey] = !task.completions[dateKey];
  }

  // if it's now completed, fade it out
  if ((task.repeat === 'once' && task.completed) ||
      (task.repeat === 'daily' && task.completions[dateKey])) {
    const li = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
    li.classList.add('fade-out');
    setTimeout(() => li.remove(), 500);  // remove after 0.5s
  }

  saveUserData();
  renderTasks();  // re-render the rest
}

  function deleteTask(taskId) {
    taskLists[currentTaskList] = taskLists[currentTaskList].filter(t => t.id != taskId);
    saveUserData();
    renderTasks();
  }

  // Replace the initializeTaskControls function with this improved version
  function initializeTaskControls() {
    console.log("Initializing task controls...");
    
    // Setup task toggle buttons
    document.querySelectorAll('.task-toggle button').forEach(button => {
      // Clean up existing listeners
      const newButton = button.cloneNode(true);
      button.parentNode.replaceChild(newButton, button);
      
      // Determine which list this button is for
      let listType;
      if (newButton.id === 'personalTasksBtn') {
        listType = 'personal';
      } else if (newButton.id === 'workTasksBtn') {
        listType = 'work';
      } else {
        listType = newButton.textContent.toLowerCase().replace(/\s+/g, '-');
      }
      
      // Add new click handler
      newButton.onclick = function() {
        switchTaskList(listType);
      };
    });
    
    // Setup add task button
    const addTaskBtn = document.querySelector('.add-task-btn');
    if (addTaskBtn) {
      const newAddTaskBtn = addTaskBtn.cloneNode(true);
      addTaskBtn.parentNode.replaceChild(newAddTaskBtn, addTaskBtn);
      newAddTaskBtn.onclick = addTask;
    }
    
    // Setup new list and delete list buttons
    const newListBtn = document.querySelector('.new-list-btn');
    if (newListBtn) {
      const newNewListBtn = newListBtn.cloneNode(true);
      newListBtn.parentNode.replaceChild(newNewListBtn, newListBtn);
      newNewListBtn.onclick = createNewList;
    }
    
    const deleteListBtn = document.querySelector('.delete-list-btn');
    if (deleteListBtn) {
      const newDeleteListBtn = deleteListBtn.cloneNode(true);
      deleteListBtn.parentNode.replaceChild(newDeleteListBtn, deleteListBtn);
      newDeleteListBtn.onclick = deleteCurrentList;
    }
    
    // Make sure current list exists
    if (!taskLists[currentTaskList]) {
      currentTaskList = 'personal';
    }
    
    // Update UI to show current list as active
    document.querySelectorAll('.task-toggle button').forEach(btn => {
      btn.classList.remove('active');
      if ((btn.id === 'personalTasksBtn' && currentTaskList === 'personal') ||
          (btn.id === 'workTasksBtn' && currentTaskList === 'work') ||
          (btn.textContent.toLowerCase().replace(/\s+/g, '-') === currentTaskList)) {
        btn.classList.add('active');
      }
    });
    
    // Render tasks for current list
    renderTasks();
    
    console.log("Task controls initialized for list:", currentTaskList);
  }

  // Remove direct action functions (we don't need them anymore)
  function initializeTaskFunctions() {
    // Ensure our key task functions are available to the HTML
    window.addTask = addTask;
    window.toggleTask = toggleTask;
    window.deleteTask = deleteTask;
    window.switchTaskList = switchTaskList;
    window.createNewList = createNewList;
    window.deleteCurrentList = deleteCurrentList;
    
    // Initialize the controls
    setTimeout(initializeTaskControls, 100);
  }

  // Make functions available globally to be called from HTML
  window.loginWithGoogle = loginWithGoogle;
  window.previousMonth = previousMonth;
  window.nextMonth = nextMonth;
  window.openJournal = openJournal;
  window.openJournalMode = openJournalMode;
  window.closeJournalForm = closeJournalForm;
  window.changeJournalDay = changeJournalDay;
  window.addEvent = addEvent;
  window.saveEvent = saveEvent;
  window.closeEventForm = closeEventForm;
  window.deleteEvent = deleteEvent;
  window.saveJournal = saveJournal;
  window.toggleRecording = toggleRecording;
  window.handleAudioUpload = handleAudioUpload;
  window.handleImageUpload = handleImageUpload;
  window.goToGoalsPage = goToGoalsPage;
  window.saveGoals = saveGoals;
  window.closeGoalsForm = closeGoalsForm;
  window.goToJournalFromGoals = goToJournalFromGoals;
  window.changeToHabit = changeToHabit;
  window.changeToJournal = changeToJournal;
  window.showNewHabitForm = showNewHabitForm;
  window.confirmAddHabit = confirmAddHabit;
  window.cancelAddHabit = cancelAddHabit;
  window.saveHabitTracker = saveHabitTracker;
  window.cancelHabitTracker = cancelHabitTracker;
  window.logoutFromGoogle = logoutFromGoogle;

  // Add task functions to window object
  window.addTask = addTask;
  window.toggleTask = toggleTask;
  window.deleteTask = deleteTask;
  window.switchTaskList = switchTaskList;
  window.createNewList = createNewList;
  window.deleteCurrentList = deleteCurrentList;

  // Initialize the task functionality
  initializeTaskControls();

  // ─── expose everything HTML calls ───
Object.assign(window, {
  // auth & nav
  loginWithGoogle, logoutFromGoogle, previousMonth, nextMonth,
  // journal & goals
  openJournal, closeJournalForm, changeJournalDay, saveJournal,
  openJournalMode,
  goToGoalsPage, saveGoals, closeGoalsForm, goToJournalFromGoals,
  toggleRecording, handleAudioUpload, handleImageUpload,
  // events
  addEvent, editEvent, saveEvent, deleteEvent, closeEventForm,
  // tasks
  addTask, toggleTask, deleteTask, switchTaskList,
  createNewList, deleteCurrentList,
  // habits
  changeToHabit, changeToJournal, showNewHabitForm,
  confirmAddHabit, cancelAddHabit, saveHabitTracker, cancelHabitTracker
});
generateCalendar();   // render current month on first load

// Add an event listener to the button directly
document.getElementById('logoutButton').addEventListener('click', async () => {
  try {
    await signOut(auth);
    console.log("User signed out successfully");
    // Clear local data and UI updates...
  } catch (error) {
    console.error("Error signing out:", error);
  }
});

// Implement the habit functions
function _changeToHabit() {
  const journalForm = document.getElementById('journalForm');
  const habitForm = document.getElementById('habitForm');
  const date = journalForm.dataset.date;
  
  journalForm.style.display = 'none';
  habitForm.style.display = 'block';
  habitForm.dataset.date = date;
  
  document.getElementById('habitDate').textContent = new Date(date + 'T00:00:00').toLocaleDateString();
  renderHabits(date);
}

function _changeToJournal() {
  document.getElementById('habitForm').style.display = 'none';
  document.getElementById('journalForm').style.display = 'block';
}

function _showNewHabitForm() {
  document.getElementById('newHabitForm').style.display = 'block';
}

function _confirmAddHabit() {
  const habitName = document.getElementById('newHabitName').value.trim();
  if (!habitName) return alert('Please enter a habit name');
  
  const habitType = document.querySelector('input[name="habitType"]:checked').value;
  
  globalHabits.push({
    id: Date.now(),
    name: habitName,
    type: habitType
  });
  
  saveUserData();
  document.getElementById('newHabitForm').style.display = 'none';
  renderHabits(document.getElementById('habitForm').dataset.date);
}

function _cancelAddHabit() {
  document.getElementById('newHabitForm').style.display = 'none';
}

function _saveHabitTracker() {
  saveUserData();
  document.getElementById('habitForm').style.display = 'none';
  document.getElementById('journalForm').style.display = 'block';
}

function _cancelHabitTracker() {
  document.getElementById('habitForm').style.display = 'none';
  document.getElementById('journalForm').style.display = 'block';
}

function renderHabits(date) {
  const habitList = document.getElementById('habitList');
  habitList.innerHTML = '';
  
  if (globalHabits.length === 0) {
    habitList.innerHTML = '<p>No habits created yet. Click "Add Habit" to get started.</p>';
    return;
  }
  
  globalHabits.forEach(habit => {
    const div = document.createElement('div');
    div.style.margin = '10px 0';
    div.style.padding = '10px';
    div.style.border = '1px solid #ddd';
    div.style.borderRadius = '4px';
    
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems = 'center';
    
    if (habit.type === 'check') {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.style.marginRight = '10px';
      checkbox.checked = habitTracker[date]?.[habit.id]?.completed || false;
      checkbox.onchange = () => {
        habitTracker[date] = habitTracker[date] || {};
        habitTracker[date][habit.id] = habitTracker[date][habit.id] || {};
        habitTracker[date][habit.id].completed = checkbox.checked;
      };
      
      label.appendChild(checkbox);
    } else { // count type
      const count = document.createElement('input');
      count.type = 'number';
      count.min = '0';
      count.style.width = '60px';
      count.style.marginRight = '10px';
      count.value = habitTracker[date]?.[habit.id]?.count || 0;
      count.onchange = () => {
        habitTracker[date] = habitTracker[date] || {};
        habitTracker[date][habit.id] = habitTracker[date][habit.id] || {};
        habitTracker[date][habit.id].count = parseInt(count.value) || 0;
      };
      
      label.appendChild(count);
    }
    
    const name = document.createElement('span');
    name.textContent = habit.name;
    label.appendChild(name);
    
    div.appendChild(label);
    habitList.appendChild(div);
  });
}

// Expose habit functions to window
window._changeToHabit = _changeToHabit;
window._changeToJournal = _changeToJournal;
window._showNewHabitForm = _showNewHabitForm;
window._confirmAddHabit = _confirmAddHabit;
window._cancelAddHabit = _cancelAddHabit;
window._saveHabitTracker = _saveHabitTracker;
window._cancelHabitTracker = _cancelHabitTracker;
</script>

</body>
</html>
