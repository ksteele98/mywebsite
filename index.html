<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="/mywebsite/manifest.json">
  <title>Calendar App (Google Auth)</title>

  <style>
    /* === Your existing CSS unchanged === */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .calendar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #ddd;
    }
    .calendar-cell {
      background-color: white;
      min-height: 100px;
      padding: 10px;
      cursor: pointer;
      user-select: none;
      overflow: hidden;
    }
    .calendar-cell.today {
      border: 2px solid lightblue;
    }
    .day-header {
      background-color: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    .date-number {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .event {
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      margin-bottom: 2px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .nav-button {
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 8px 16px;
      cursor: pointer;
      width: auto;
      min-width: 100px;
    }
    .day-nav-button {
      padding: 0;
      width: 40px;
      height: 40px;
      min-width: 40px;
      border-radius: 50%;
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1100;
      display: none;
    }
    #prevDayButton { left: 10px; }
    #nextDayButton { right: 10px; }
    .current-month {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }
    .event-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 300px;
      z-index: 1000;
    }
    .event-form input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .event-form h3 {
      margin-top: 0;
      margin-bottom: 15px;
    }
    .color-picker {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(25px, 1fr));
      gap: 5px;
      margin: 10px 0;
    }
    .color-option {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .color-option.selected {
      border: 2px solid #000;
    }
    .task-reminder-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 300px;
      z-index: 1000;
      max-height: 90vh;
      overflow-y: auto;
    }
    .task-reminder-form input,
    .task-reminder-form select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    /* Styles for the task edit button and day picker */
    .task-item-controls {
      margin-left: auto;
      display: flex;
      gap: 5px;
    }

    .edit-task-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0 5px;
    }

    .weekday-picker {
      display: flex;
      justify-content: space-around;
      padding: 8px;
      background-color: #f7f7f7;
      border-radius: 4px;
      margin-top: 5px;
    }

    .weekday-picker label {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .weekday-picker input:checked + span {
      font-weight: bold;
      color: #4285f4;
    }
    .time-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .time-inputs div {
      flex: 1;
      min-width: 120px;
    }
    .time-inputs label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .time-inputs input[type="time"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .reminder-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .reminder-inputs div {
      flex: 1;
      min-width: 120px;
    }
    .reminder-inputs label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .reminder-inputs input[type="time"],
    .reminder-inputs input[type="date"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .time-picker {
      display: none;
    }
    .event-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .event-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 80px;
    }
    .event-actions button:first-child {
      background: #4285f4;
      color: white;
    }
    .event-actions button:last-child {
      background: #ddd;
    }
    .delete-event-btn {
      background: #dc3545 !important;
      color: white;
    }
    .journal-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
      display: none;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .journal-textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      resize: vertical;
      box-sizing: border-box;
      border: none;
      overflow-x: hidden;
    }
    .other-month {
      background-color: #f5f5f5;
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
      position: relative;
    }
    .task-item {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
      gap: 5px;
      transition: opacity 4s ease;
      opacity: 1;
    }
    .task-item.fade-out {
      opacity: 0;
    }
    .task-item input[type="checkbox"] {
      margin-right: 10px;
    }
    .subtask-list {
      list-style: none;
      padding-left: 20px;
      margin-top: 4px;
    }
    .subtask-item {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 2px 0;
      transition: opacity 5s ease;
      opacity: 1;
    }
    .subtask-item.fade-out {
      opacity: 0;
    }
    .toggle-subtasks-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 4px;
      font-size: 14px;
    }
    .task-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .task-severity-select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .add-task-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      width: 100%;
    }
    .completed-task {
      text-decoration: line-through;
      color: #888;
    }
    .task-container {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      position: relative;
    }
    .task-toggle {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .task-toggle button {
      flex: 1;
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 4px;
      min-width: 120px;
    }
    .task-toggle button.active {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }
    .daily-events {
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .daily-events h4 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .add-event-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    .new-list-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
      min-width: auto;
      flex: 0;
    }
    .delete-list-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: auto;
      flex: 0;
    }
    .clear-tasks-btn {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: auto;
      flex: 0;
    }
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .change-habit-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .habit-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    #habitDate {
      margin-bottom: 10px;
    }
    .new-habit-form {
      margin-top: 20px;
      display: none; 
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }
    .new-habit-form h4 {
      margin-top: 0;
    }
    .habit-type-options label {
      margin-right: 10px;
    }
    .goals-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .audio-section button {
      padding: 6px 12px;
      margin-right: 10px;
    }
    .media-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .file-upload-input {
      display: none;
    }
    .file-upload-label {
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }

    .image-section img {
      max-width: 100%;
      margin: 10px 0;
      display: block;
    }

    .task-buttons {
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
    }

    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 16px;
      line-height: 20px;
      cursor: pointer;
    }

    /* Popup for missed reminders */
    .reminder-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .reminder-popup .popup-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 300px;
      width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    @media screen and (max-width: 768px) {
      .calendar-grid {
        font-size: 14px;
      }
      .calendar-cell {
        min-height: 80px;
        padding: 5px;
      }
      .event {
        font-size: 10px;
        padding: 1px 3px;
      }
      .current-month {
        font-size: 16px;
        width: 100%;
        text-align: center;
        order: -1;
      }
      .nav-button {
        padding: 6px 12px;
        min-width: auto;
        flex: 1;
      }
      .journal-form button {
        margin-bottom: 20px;
        padding: 12px;
        font-size: 16px;
      }
    }
    @media screen and (max-width: 480px) {
      body {
        padding: 10px;
      }
      .calendar-cell {
        min-height: 60px;
      }
      .day-header {
        padding: 5px;
        font-size: 12px;
      }
      .date-number {
        font-size: 12px;
      }
      .event {
        margin-bottom: 1px;
      }
      .time-inputs div {
        flex: 100%;
      }
      .reminder-inputs div {
        flex: 100%;
      }
      .task-toggle button {
        flex: 100%;
      }
    }

    /* ========== 1. Kill the sideways scroll ========== */
    html,body {
      overflow-x:hidden;           /* hard stop */
    }
    .calendar-container,
    .journal-form,
    .event-form,
    .habit-form,
    .task-reminder-form,
    .goals-form {
      max-width:100vw;             /* never exceed the viewport */
      box-sizing:border-box;       /* include padding/border in that width */
    }

    /* ========== 3. Give buttons breathing space ========== */
    .media-controls,
    .event-actions,
    .reminder-inputs,
    .time-inputs {
      gap:12px;                    /* modern browsers respect flex-gap */
      flex-wrap:wrap;              /* let them drop to a new row */
    }
    .media-controls button,
    .media-controls label,
    .event-actions button {
      flex:1 1 48%;                /* two per row on tiny screens */
      min-width:120px;             /* avoid micro-buttons */
    }

    /* ========== 4. Highlight “today” everywhere ========== */
    /* calendar cell already had a blue border; match it in journal modal */
    .journal-form.today{
      border:2px solid #79bfff;    /* soft light-blue outline */
    }

    /* ========== PHONE POLISH (≤480 px) ========== */
    @media (max-width:480px){

      /* 1. Shrink the journal popup to ~70 % of the screen */
      .journal-form,
      .habit-form,
      .event-form,
      .task-reminder-form,
      .goals-form{
        width:70vw;            /* ~70 % of viewport */
        max-width:420px;       /* don’t let big phones stretch it */
        margin:0 auto;         /* center horizontally */
        padding:12px;          /* lighter padding */
      }

      /* 2. Journal pop-up: a hair shorter so it doesn’t run to the chin-bar */
      .journal-form{
        max-height:85vh;      /* cap vertical size */
        overflow-y:auto;      /* scroll inside if content is taller */
      }

      /* 3. “Show Completed / +New List / Delete List” all on one line */
      .task-buttons{
        display:grid;
        grid-template-columns:repeat(3,1fr);  /* three equal columns */
        gap:8px;
      }

      /* 4. Slim every main button so thumbs still hit, but UI breathes */
      .journal-form button,
      .event-form  button,
      .habit-form  button,
      .task-reminder-form button,
      .task-buttons button,
      .task-toggle  button,
      .media-controls button,
      .media-controls label{
        padding:6px 10px;
        font-size:13px;
      }

      /* 5. Task buttons get slimmer and allow shrink */
      .task-buttons button{
        padding:6px 0;        /* slimmer */
        font-size:13px;
        min-width:0;          /* let them shrink */
      }

      /* 6. Keep list-toggle buttons from pinching each other */
      .task-toggle{
        gap:8px;
      }

      /* 7. Nudge the nav-arrows clear of the panel border */
      .day-nav-button{
        width:36px;
        height:36px;
        box-shadow:0 0 5px rgba(0,0,0,.25);
      }

      /* 8. Today’s journal outline—so it matches the calendar cell */
      .journal-form.today{
        border:2px solid #7ac3ff;
      }
    }
  </style>
</head>
<body>

<div id="authSection" style="display: none; text-align:center; margin-bottom: 20px;">
  <button onclick="loginWithGoogle()" style="background: #DB4437; color:white; padding: 10px 20px; border:none; border-radius:4px; cursor:pointer;">
    Sign in with Google
  </button>
</div>

<div id="logoutSection" style="display: none; text-align:right; margin-bottom: 20px;">
  <button onclick="openJournalMode()" id="journalModeBtn" style="background: #4285F4; color:white; padding: 8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right: 10px;">
    Journal Mode
  </button>
   <button id="subscribeBtn"          style="background:#FFB400;color:#000;padding:8px 16px;
               border:none;border-radius:4px;cursor:pointer;margin-right:10px">   🔔 Enable Notifications
  </button>
  <button id="pendingBtn" style="background:#6c757d;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;margin-right:10px">View Pending</button>
  <button onclick="logoutFromGoogle()" id="logoutButton" style="background: #4285F4; color:white; padding: 8px 16px; border:none; border-radius:4px; cursor:pointer;">
    Sign Out
  </button>
</div>
  


<div class="calendar-container">
  <div class="calendar-header">
    <button class="nav-button" onclick="previousMonth()">&lt; Previous</button>
    <div class="current-month"></div>
    <button class="nav-button" onclick="nextMonth()">Next &gt;</button>
  </div>
  <div class="calendar-grid">
    <div class="day-header">Sun</div>
    <div class="day-header">Mon</div>
    <div class="day-header">Tue</div>
    <div class="day-header">Wed</div>
    <div class="day-header">Thu</div>
    <div class="day-header">Fri</div>
    <div class="day-header">Sat</div>
  </div>
</div>

<div class="event-form" id="eventForm">
  <h3>Add Event</h3>
  <input type="text" id="eventDescription" placeholder="Event Name" required>
  <div class="time-inputs">
    <div>
      <label for="eventStartTime">Start Time:</label>
      <input type="time" id="eventStartTime" required>
    </div>
    <div>
      <label for="eventEndTime">End Time:</label>
      <input type="time" id="eventEndTime" required>
    </div>
  </div>
  <div class="reminder-inputs">
    <div>
      <label for="reminderDate">Reminder Date (optional):</label>
      <input type="date" id="reminderDate">
    </div>
    <div>
      <label for="reminderTime">Reminder Time (optional):</label>
      <input type="time" id="reminderTime">
    </div>
  </div>
  <h4>Select Color:</h4>
  <div class="color-picker" id="colorPicker"></div>
  <input type="hidden" id="eventDate">
  <input type="hidden" id="eventId">
  <div class="event-actions">
    <button onclick="saveEvent()">Save Event</button>
    <button onclick="closeEventForm()">Cancel</button>
    <button onclick="deleteEvent()" class="delete-event-btn">Delete</button>
  </div>
</div>
<!-- MODIFIED: Task Edit/Reminder Form -->
<div class="task-reminder-form" id="taskReminderForm">
  <h3>Edit Task</h3>
  <label for="taskEditText">Task Name:</label>
  <input type="text" id="taskEditText" placeholder="Task Name">
  <div>
    <label for="taskReminderDate">Reminder Date (optional):</label>
    <input type="date" id="taskReminderDate">
  </div>
  <div>
    <label for="taskReminderTime">Reminder Time (optional):</label>
    <input type="time" id="taskReminderTime">
  </div>
  <div>
    <label for="taskReminderSeverity">Severity:</label>
    <select id="taskReminderSeverity" class="task-severity-select">
      <option value="0" selected></option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
  </div>
  <div>
    <label for="taskRepeat">Repeat:</label>
    <select id="taskRepeat" onchange="toggleWeeklyOptions(this.value)">
      <option value="none">Never</option>
      <option value="daily">Every Day</option>
      <option value="weekly">Once a Week</option>
      <option value="weekdays">Weekdays</option>
      <option value="weekends">Weekends</option>
      <option value="biweekly">Bi-weekly</option>
      <option value="monthly">Monthly</option>
      <option value="quarterly">Every 3 Months</option>
      <option value="semiannual">Every 6 Months</option>
      <option value="yearly">Yearly</option>
    </select>
  </div>
  <!-- NEW: Weekly day picker -->
  <div id="weeklyRepeatOptions" style="display: none;">
      <label>Repeat on:</label>
      <div class="weekday-picker">
          <label><input type="radio" name="repeatDay" value="0"><span>S</span></label>
          <label><input type="radio" name="repeatDay" value="1"><span>M</span></label>
          <label><input type="radio" name="repeatDay" value="2"><span>T</span></label>
          <label><input type="radio" name="repeatDay" value="3"><span>W</span></label>
          <label><input type="radio" name="repeatDay" value="4"><span>T</span></label>
          <label><input type="radio" name="repeatDay" value="5"><span>F</span></label>
          <label><input type="radio" name="repeatDay" value="6"><span>S</span></label>
      </div>
  </div>

  <input type="hidden" id="taskReminderId">
  <div class="event-actions">
    <button onclick="saveTaskDetails()">Save Details</button>
    <button onclick="closeTaskReminderForm()">Cancel</button>
  </div>
</div>

<div class="journal-form" id="journalForm">
  <button class="goals-btn" onclick="goToGoalsPage()">Go To Goals</button>
  <button class="change-habit-btn" onclick="changeToHabit()">Change to Habit</button>
  <h3>Daily Overview</h3>
  <div id="journalDate" style="margin-bottom: 10px;"></div>

  <div class="daily-events">
    <h4>Events</h4>
    <div id="dailyEventsList"></div>
    <button class="add-event-btn" onclick="addEvent(document.getElementById('journalForm').dataset.date)">Add Event</button>
  </div>

  <h4>Journal Entry</h4>
  <textarea id="journalText" class="journal-textarea" placeholder="Write your thoughts for this day..."></textarea>

  <div class="audio-section">
    <div style="position:relative;">
      <audio id="audioPlayer" controls style="display:none; width:100%; margin:10px 0;"></audio>
      <button id="removeAudioBtn" class="remove-btn" onclick="removeAudio()" style="display:none;">&#215;</button>
    </div>
  </div>

  <div class="media-controls">
    <button id="recordAudioBtn" onclick="toggleRecording()">Start Recording</button>
    <label for="audioFileInput" class="file-upload-label">Upload Audio</label>
    <input type="file" id="audioFileInput" accept="audio/*,video/mpeg" onchange="handleAudioUpload(event)" class="file-upload-input">
    <label for="imageFileInput" class="file-upload-label">Upload Image</label>
    <input type="file" id="imageFileInput" accept="image/*" onchange="handleImageUpload(event)" class="file-upload-input">
  </div>

  <div class="image-section" style="position:relative;">
    <img id="imagePreview" style="display:none; width:100%; margin:10px 0;" />
    <button id="removeImageBtn" class="remove-btn" onclick="removeImage()" style="display:none;">&#215;</button>
  </div>
  

  <div class="task-container">
    <div class="tasks-header">
      <h3>Tasks</h3>
      <div class="task-buttons">
        <button id="toggleCompletedBtn" class="new-list-btn" onclick="toggleCompletedView()">Show Completed</button>
        <button class="new-list-btn" onclick="createNewList()">+ New List</button>
        <button class="delete-list-btn" onclick="deleteCurrentList()">Delete List</button>
        <button class="clear-tasks-btn" onclick="clearAllTasks()">Clear All Tasks</button>
      </div>
    </div>
    <div class="task-toggle">
      <button onclick="switchTaskList('personal')" id="personalTasksBtn" class="active">Personal Tasks</button>
      <button onclick="switchTaskList('work')" id="workTasksBtn">Work Tasks</button>
    </div>
    <label style="display: block; margin: 8px 0; font-size: 14px;">
      Severity:
      <select id="taskSeverity" class="task-severity-select">
        <option value="0" selected></option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </label>

    <input type="text" id="taskInput" class="task-input" placeholder="Add a new task">
    <button class="add-task-btn" onclick="addTask()">Add Task</button>
    <ul class="task-list" id="taskList"></ul>
  </div>

  <button onclick="saveJournal()">Save</button>
  <button onclick="closeJournalForm()">Cancel</button>
</div>

<button id="prevDayButton" class="nav-button day-nav-button" onclick="changeJournalDay(-1)">&lt;</button>
<button id="nextDayButton" class="nav-button day-nav-button" onclick="changeJournalDay(1)">&gt;</button>

<div class="habit-form" id="habitForm" style="display: none;" data-date="">
  <div id="habitDate" style="margin-bottom: 10px;"></div>
  <button class="change-habit-btn" onclick="changeToJournal()">Change to Journal</button>
  <h3>Habit Tracker</h3>
  <div id="habitList"></div>
  <button onclick="showNewHabitForm()">Add Habit</button>
  <button onclick="saveHabitTracker()">Save</button>
  <button onclick="cancelHabitTracker()">Cancel</button>

  <div class="new-habit-form" id="newHabitForm">
    <h4>Add a New Habit</h4>
    <input type="text" id="newHabitName" placeholder="Habit Name">
    <div class="habit-type-options">
      <label><input type="radio" name="habitType" value="count" checked> Count</label>
      <label><input type="radio" name="habitType" value="check"> Check</label>
    </div>
    <button onclick="confirmAddHabit()">Save New Habit</button>
    <button onclick="cancelAddHabit()">Cancel</button>
  </div>
</div>

<div class="goals-form" id="goalsForm" style="display: none; position: fixed; top: 50%; left: 50%;
transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; 
box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; z-index: 1000;">
  <button onclick="goToJournalFromGoals()" 
    style="position: absolute; top: 10px; right: 10px; background:#4285f4; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
    Go to Journal
  </button>
  <h3>Goals</h3>
  <p>Write your goals here...</p>
  <textarea id="goalsText" style="width:100%; height:100px;" placeholder="Your goals..."></textarea>
  <div style="display: flex; gap: 10px; margin-top: 20px;">
    <button onclick="saveGoals()" style="flex:1; background:#4285f4; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">
      Save
    </button>
    <button onclick="closeGoalsForm()" style="flex:1; background:#ddd; border:none; padding:10px; border-radius:4px; cursor:pointer;">
      Cancel
    </button>
  </div>
</div>


<div id="missedRemindersPopup" class="reminder-popup" style="display:none;">
  <div class="popup-content">
    <h3>Missed Reminders</h3>
    <ul id="missedRemindersList" style="padding-left:20px;"></ul>
    <button onclick="closeMissedRemindersPopup()">Close</button>
  </div>
</div>

<div id="reminderPopup" class="reminder-popup" style="display:none;">
  <div class="popup-content">
    <p id="reminderPopupMsg"></p>
    <button onclick="closeReminderPopup()">Close</button>
  </div>
</div>

<div id="pendingRemindersPopup" class="reminder-popup" style="display:none;">
  <div class="popup-content">
    <h3 id="pendingRemindersTitle">Pending Reminders</h3>
    <button id="toggleReminderViewBtn" onclick="toggleReminderView()" style="margin-bottom:10px;">Show Past</button>
    <ul id="pendingRemindersList" style="padding-left:20px;"></ul>
    <button onclick="closePendingRemindersPopup()">Close</button>
  </div>
</div>


  </div>
</div>

<script>
  // Create global function that will call the internal module function
  function logoutFromGoogle() {
    // This will be defined by the module script
    window._logoutFromGoogle && window._logoutFromGoogle();
  }
  
  function loginWithGoogle() {
    window._loginWithGoogle && window._loginWithGoogle();
  }

  function changeToHabit() {
    window._changeToHabit && window._changeToHabit();
  }
  
  function changeToJournal() {
    window._changeToJournal && window._changeToJournal();
  }
  
  function showNewHabitForm() {
    window._showNewHabitForm && window._showNewHabitForm();
  }
  
  function confirmAddHabit() {
    window._confirmAddHabit && window._confirmAddHabit();
  }
  
  function cancelAddHabit() {
    window._cancelAddHabit && window._cancelAddHabit();
  }

  function deleteHabit(id) {
    window._deleteHabit && window._deleteHabit(id);
  }
  
  function saveHabitTracker() {
    window._saveHabitTracker && window._saveHabitTracker();
  }
  
  function cancelHabitTracker() {
    window._cancelHabitTracker && window._cancelHabitTracker();
  }

  function openTaskEditor(taskId, listName) {
    window._openTaskEditor && window._openTaskEditor(taskId, listName);
  }

  function saveTaskDetails() {
    window._saveTaskDetails && window._saveTaskDetails();
  }

  function closeTaskReminderForm() {
    window._closeTaskReminderForm && window._closeTaskReminderForm();
  }

  function toggleWeeklyOptions(value) {
    window._toggleWeeklyOptions && window._toggleWeeklyOptions(value);
  }
</script>
<script type="module">
// ─── expose everything HTML calls ───

  /********************** 1) Firebase Imports
  ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-analytics.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    addDoc,
    collection,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-storage.js";
  // NEW: push-subscription flow -------------------------------

  /********************** 2) Firebase Config 
       (from your snippet)
  ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyCmtc69JDgCWtxPNgPU73Y4n7-asl6M72w",
    authDomain: "my-website-5dfa1.firebaseapp.com",
    projectId: "my-website-5dfa1",
    storageBucket: "my-website-5dfa1.appspot.com",
    messagingSenderId: "36790147861",
    appId: "1:36790147861:web:6391e58fe3193c4fabe71c",
    measurementId: "G-SSJEV8WQFT"
  };

  /********************** 3) Init Firebase
  ***********************/
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const storage = getStorage(app);

   // 🔓 make them globally visible for debugging
  window.app     = app;
  window.auth    = auth;
  window.storage = storage;


  let userId = null;  // will store current Google user's uid here
  let userLastOpenTime = 0; // track last time user opened app across devices
  const provider = new GoogleAuthProvider();

  // This function triggers the Google popup
  async function _loginWithGoogle() {
    try {
      const result = await signInWithPopup(auth, provider);
      console.log("Google sign-in success!");
    } catch (error) {
      console.error("Google Sign-In Error:", error);
    }
  }

  // On page load, watch for auth changes
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('logoutSection').style.display = 'block';
      await loadUserData();
      scheduleAllReminders();
      await showMissedReminders();
      generateCalendar();
      renderTasks();
    } else {
      userId = null;
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('logoutSection').style.display = 'none';
    }
  });

  // Update the logout function to store on window
  async function _logoutFromGoogle() {
    try {
      await signOut(auth);
      console.log("User signed out successfully");
      events = [];
      journalEntries = {};
      journalAudios = {};
      journalImages = {};
      taskLists = { personal: [], work: [] };
      habitTracker = {};
      globalHabits = [];
      generateCalendar();
    } catch (error) {
      console.error("Error signing out:", error);
    }
  }

  // Store the internal function on window
  window._logoutFromGoogle = _logoutFromGoogle;
  window._loginWithGoogle = _loginWithGoogle;

//******************************************************************
// 🔔 PUSH NOTIFICATION SETUP
//******************************************************************
import {
  isSupported as messagingIsSupported,
  getMessaging,
  getToken,
  onMessage
} from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-messaging.js';

let userFcmToken = null;

async function fcmSupported() {
  try {
    return await messagingIsSupported();
  } catch {
    return false;
  }
}

async function initFCM() {
  if (!await fcmSupported()) return;

  await navigator.serviceWorker.register('./firebase-messaging-sw.js', {
    scope: './'
  });
  console.log('✅ SW registered');

  async function subscribeForPush() {
    const messaging = getMessaging(app);
    const swReg = await navigator.serviceWorker.ready;
    const fcmToken = await getToken(messaging, {
      vapidKey: 'BHI71aycFWx3ntjc3nuZvAGDvAakYzBd-0cCRl8YuswkYkX3hQ9j4sysD6XXNBWrPZSsGHB2isMfC6u-3Uounzo',
      serviceWorkerRegistration: swReg
    });
    console.log('✅ FCM token acquired:', fcmToken);
    userFcmToken = fcmToken;
    window.userFcmToken = fcmToken;
    const uid = auth.currentUser?.uid;
    if (uid) await setDoc(doc(db, 'users', uid), { fcmToken }, { merge: true });
    const subBtn = document.getElementById('subscribeBtn');
    if (subBtn) {
      subBtn.disabled = true;
      subBtn.textContent = 'Notifications On';
      subBtn.style.display = 'none';
    }
  }

  const subBtn = document.getElementById('subscribeBtn');
  if (!subBtn) return;
  subBtn.addEventListener('click', async () => {
    if (await Notification.requestPermission() !== 'granted') return;
    try {
      await subscribeForPush();
      alert('🎉 Notifications enabled!');
    } catch (err) {
      console.error('FCM token error', err);
      alert('Could not subscribe for push. Check console.');
    }
  });

  if (Notification.permission === 'granted') {
    try { await subscribeForPush(); } catch (err) {
      console.error('FCM auto-subscribe error', err);
    }
  }

  const messaging = getMessaging(app);
  onMessage(messaging, ({ data }) => {
    if (!data) return;
    new Notification(data.title, { body: data.body });
  });
}

initFCM();

  /******************************************************* 4) In-Memory Data
  *******************************************************/
  let currentDate   = new Date();
  let events        = [];
  let selectedColor = '#4285f4';
  let journalEntries = {};
  let taskLists     = { personal: [], work: [] };
  let currentTaskList = 'personal';
  let completedTasks = {};
  let showingCompleted = false;

  let habitTracker = {};
  let globalHabits = [];
  let journalAudios = {};
  let journalImages = {};
  let pendingAudioFile = null;
  let pendingImageFile = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let reminderTimeouts = {};
  let taskReminderTimeouts = {};
  let showPastReminders = false;

  let journalMode = false;
  let editingTaskInfo = { id: null, listName: null };
  let journalEntryDates = [];
  let journalEntryIndex = 0;


  /******************************************************* 5) Firestore Load/Save 
  *******************************************************/
  async function loadUserData() {
    if (!userId) return;
    try {
      const docRef = doc(db, "users", userId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        events          = data.events          || [];
        journalEntries  = data.journalEntries  || {};
        journalAudios   = data.journalAudios || {};
        journalImages   = data.journalImages || {};
        taskLists       = data.taskLists       || { personal: [], work: [] };
        completedTasks  = data.completedTasks  || {};
        habitTracker    = data.habitTracker    || {};
        globalHabits    = data.globalHabits    || [];
        userLastOpenTime = data.lastOpenTime || parseInt(localStorage.getItem('lastOpenTime') || '0', 10);
        document.getElementById('goalsText').value = data.userGoals || '';

      } else {
        console.log("No existing Firestore doc for this user; starting fresh.");
        taskLists = { personal: [], work: [] };
        completedTasks = {};
        userLastOpenTime = parseInt(localStorage.getItem('lastOpenTime') || '0', 10);
      }

      await migrateAndCleanCompletedTasks();
      renderTaskListButtons();
      initializeTaskControls();
      scheduleAllTaskReminders();
    } catch (err) {
      console.error("Error loading user data:", err);
    }
  }

  async function saveUserData() {
    if (!userId) return;
    try {
      const docRef = doc(db, "users", userId);
      await setDoc(docRef, {
        events,
        journalEntries,
        journalAudios,
        journalImages,
        taskLists,
        completedTasks,
        habitTracker,
        globalHabits,
        lastOpenTime: userLastOpenTime,
        userGoals: document.getElementById('goalsText')?.value || ''
      });
      console.log("Data saved to Firestore!");
      scheduleAllTaskReminders();
    } catch (err) {
      console.error("Error saving user data:", err);
    }
  }
  
  /*******************************************************
   * NEW: One-Time Data Cleanup Function
   *******************************************************/
  async function migrateAndCleanCompletedTasks() {
      if (!userId) {
          console.error("You must be logged in to run the cleanup.");
          alert("You must be logged in to run the cleanup.");
          return;
      }
      
      console.log("Starting task cleanup and migration...");
      let tasksMigrated = 0;
      let newActiveTaskLists = {};

      // Iterate over every task list (personal, work, etc.)
      for (const listName in taskLists) {
          const activeTasks = [];
          const taskList = taskLists[listName];

          // Iterate over every task in the current list
          for (const task of taskList) {
              // Check if the task is a non-repeating task and has completed: true
              if (task.repeat === 'none' && task.completed) {
                  // This task needs to be migrated.
                  // Use the task's startDate as the completion date.
                  const completionDate = task.startDate || formatLocalDate(new Date());
                  
                  // Ensure the completedTasks structure for this date exists
                  if (!completedTasks[completionDate]) {
                      completedTasks[completionDate] = [];
                  }

                  // Add the task to the completed list for that date
                  // Avoid adding duplicates
                  if (!completedTasks[completionDate].some(t => t.id === task.id)) {
                      completedTasks[completionDate].push({ ...task, list: listName });
                      tasksMigrated++;
                  }
                  // Do NOT add this task to the new activeTasks list.
              } else {
                  // This task is still active, so keep it.
                  activeTasks.push(task);
              }
          }
          // Replace the old active list with the cleaned one.
          newActiveTaskLists[listName] = activeTasks;
      }

      // Overwrite the old taskLists with our newly cleaned lists.
      taskLists = newActiveTaskLists;

      console.log(`Cleanup complete. Migrated ${tasksMigrated} tasks.`);
      if (tasksMigrated > 0) {
          await saveUserData();
          alert(`Cleanup complete! Migrated ${tasksMigrated} previously completed tasks to their correct dates.`);
      }

      // Refresh the UI to show the clean lists.
      renderTasks();
  }
  // Make the cleanup function accessible from the browser console
  window.migrateAndCleanCompletedTasks = migrateAndCleanCompletedTasks;


 /*******************************************************
   Clear all incomplete tasks
  *******************************************************/
  async function clearAllTasks() {
      if (!userId) {
          console.error("You must be logged in to clear tasks.");
          alert("You must be logged in to clear tasks.");
          return;
      }

      if (!confirm("Clear all incomplete tasks?")) return;

      console.log("Clearing all incomplete tasks...");

      // Remove all tasks from each list
      for (const listName in taskLists) {
          taskLists[listName] = [];
      }

      // Clear any existing reminder timers
      Object.values(taskReminderTimeouts).forEach(clearTimeout);
      taskReminderTimeouts = {};

      await saveUserData();
      renderTasks();

      alert("All incomplete tasks have been cleared.");
  }
  window.clearAllTasks = clearAllTasks;


  /******************************************************* 6) Color Picker
  *******************************************************/
    const colors = [
    '#FF0000','#F76C6C','#FF6B6B','#D4A5A5',
    '#FF4500','#FFA500','#FFD700',
    '#F1C40F','#FFEEAD','#F8E9A1',
    '#90EE90','#2ECC71','#27AE60','#16A085','#A8E6CF','#DCEDC1','#96CEB4',
    '#4ECDC4','#45B7D1','#3498DB','#2980B9','#0000FF','#A8D0E6','#374785','#24305E',
    '#8E44AD','#9B59B6',
    '#BA55D3','#9400D3','#DA70D6'
  ];

  function formatTime(timeStr) {
    if (!timeStr) return '';
    const [hStr, m] = timeStr.split(":");
    let h = parseInt(hStr, 10);
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12;
    if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }

  function formatLocalDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function initializeColorPicker(preSelected = selectedColor) {
    const colorPicker = document.getElementById("colorPicker");
    colorPicker.innerHTML = "";
    colors.forEach(color => {
      const dot = document.createElement("div");
      dot.className = "color-option";
      dot.style.backgroundColor = color;
      if (color === preSelected) dot.classList.add("selected");
      dot.onclick = () => {
        document.querySelectorAll(".color-option")
                .forEach(o => o.classList.remove("selected"));
        dot.classList.add("selected");
        selectedColor = color;
      };
      colorPicker.appendChild(dot);
    });
  }

  /******************************************************* 7) Calendar Navigation 
  *******************************************************/
  function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
  }

  /******************************************************* 8) Calendar Generation
  *******************************************************/
  function generateCalendar() {
    const monthYear = document.querySelector('.current-month');
    const headers = document.querySelectorAll('.day-header');
    const oldGrid = document.querySelector('.calendar-grid');
    oldGrid.innerHTML = '';
    headers.forEach(header => oldGrid.appendChild(header.cloneNode(true)));

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthNames = ["January","February","March","April","May","June",
                        "July","August","September","October","November","December"];
    monthYear.textContent = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay  = new Date(year, month + 1, 0);
    const firstDayIndex = firstDay.getDay();

    for (let i = firstDayIndex; i > 0; i--) {
      const prevDate = new Date(year, month, -i + 1);
      const cell = createCalendarCell(prevDate, true);
      oldGrid.appendChild(cell);
    }

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const date = new Date(year, month, day);
      const cell = createCalendarCell(date, false);
      oldGrid.appendChild(cell);
    }

    const remainingCells = 42 - (firstDayIndex + lastDay.getDate());
    for (let i = 1; i <= remainingCells; i++) {
      const nextDate = new Date(year, month + 1, i);
      const cell = createCalendarCell(nextDate, true);
      oldGrid.appendChild(cell);
    }
  }

  function createCalendarCell(date, isOtherMonth) {
    const cell = document.createElement('div');
    cell.className = `calendar-cell${isOtherMonth ? ' other-month' : ''}`;
    const todayStr = formatLocalDate(new Date());
    const dateStr = formatLocalDate(date);
    if (!isOtherMonth && dateStr === todayStr) {
      cell.classList.add('today');
    }
    const dateNumber = document.createElement('div');
    dateNumber.className = 'date-number';
    dateNumber.textContent = date.getDate();
    cell.appendChild(dateNumber);
    cell.addEventListener('click', () => {
      openJournal(dateStr);
    });

    events.forEach((event) => {
      if (event.date === dateStr) {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.description;
        eventDiv.onclick = (e) => {
          e.stopPropagation();
          editEvent(event, events.indexOf(event));
        };
        cell.appendChild(eventDiv);
      }
    });

    if (journalEntries[dateStr]) {
      const journalIndicator = document.createElement('div');
      journalIndicator.className = 'event';
      journalIndicator.style.backgroundColor = '#666';
      journalIndicator.textContent = '📝 Journal Entry';
      cell.appendChild(journalIndicator);
    }

    return cell;
  }

  /******************************************************* 9) Open/Close Journal
  *******************************************************/
  async function openJournal(date) {
    const journalForm = document.getElementById('journalForm');
    const journalDate = document.getElementById('journalDate');
    const journalText = document.getElementById('journalText');
    const audioPlayer = document.getElementById('audioPlayer');
    const recordBtn = document.getElementById('recordAudioBtn');
    const fileInput = document.getElementById('audioFileInput');
    const imagePreview = document.getElementById('imagePreview');
    const imageInput = document.getElementById('imageFileInput');
    const removeAudioBtn = document.getElementById('removeAudioBtn');
    const removeImageBtn = document.getElementById('removeImageBtn');

    recordedChunks = [];
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
    recordBtn.textContent = 'Start Recording';
    fileInput.value = '';
    imageInput.value = '';

    const displayDate = new Date(date + 'T00:00:00');
    journalDate.textContent = displayDate.toLocaleDateString();
    journalText.value = journalEntries[date] || '';
    journalForm.dataset.date = date;
    journalForm.style.display = 'block';

    const todayStr = new Date().toISOString().split('T')[0];
    if (date === todayStr) {
      journalForm.classList.add('today');
    } else {
      journalForm.classList.remove('today');
    }

    if (journalAudios[date]) {
        audioPlayer.src = journalAudios[date];
        audioPlayer.style.display = 'block';
        removeAudioBtn.style.display = 'block';
    } else {
        audioPlayer.src = '';
        audioPlayer.style.display = 'none';
        removeAudioBtn.style.display = 'none';
    }

    if (journalImages[date]) {
      imagePreview.src = journalImages[date];
      imagePreview.style.display = 'block';
      removeImageBtn.style.display = 'block';
    } else {
      imagePreview.src = '';
      imagePreview.style.display = 'none';
      removeImageBtn.style.display = 'none';
    }

    document.getElementById('prevDayButton').style.display = 'block';
    document.getElementById('nextDayButton').style.display = 'block';

    updateDailyEventsList(date);
    initializeTaskControls();
  }

  function openJournalMode() {
    journalEntryDates = Object.keys(journalEntries)
      .filter(d => journalEntries[d] && journalEntries[d].trim() !== '')
      .sort();
    if (journalEntryDates.length === 0) {
      alert('No journal entries to display.');
      return;
    }
    journalEntryIndex = journalEntryDates.length - 1;
    journalMode = true;
    document.querySelector('.calendar-container').style.display = 'none';
    openJournal(journalEntryDates[journalEntryIndex]);
  }

  function closeJournalForm() {
    document.getElementById('journalForm').style.display = 'none';
    document.getElementById('prevDayButton').style.display = 'none';
    document.getElementById('nextDayButton').style.display = 'none';
    if (journalMode) {
      document.querySelector('.calendar-container').style.display = 'block';
      journalMode = false;
    }
  }

  function changeJournalDay(direction) {
    if (journalMode) {
      if (journalEntryDates.length === 0) return;
      journalEntryIndex += direction;
      if (journalEntryIndex < 0) journalEntryIndex = 0;
      if (journalEntryIndex >= journalEntryDates.length) journalEntryIndex = journalEntryDates.length - 1;
      const newDateStr = journalEntryDates[journalEntryIndex];
      openJournal(newDateStr);
      const habitForm = document.getElementById('habitForm');
      if (habitForm.style.display !== 'none') {
        _changeToHabit();
      }
      return;
    }

    const journalForm = document.getElementById('journalForm');
    const currentDateStr = journalForm.dataset.date;
    if (!currentDateStr) return;

    const [year, month, day] = currentDateStr.split('-').map(Number);
    const currentDate = new Date(year, month - 1, day);
    currentDate.setDate(currentDate.getDate() + direction);

    const newDateStr = currentDate.toISOString().split('T')[0];
    openJournal(newDateStr);
    const habitForm = document.getElementById('habitForm');
    if (habitForm.style.display !== 'none') {
      _changeToHabit();
    }
  }

  /*******************************************************
   10) Audio Recording/Upload
  *******************************************************/
  async function toggleRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      let options = { mimeType: 'audio/webm;codecs=opus' };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options = { mimeType: 'audio/webm' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options = {};
        }
      }
      const mimeType = options.mimeType || 'audio/webm';
      mediaRecorder = new MediaRecorder(stream, options);
      recordedChunks = [];
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: mimeType });
        const url = URL.createObjectURL(blob);
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.src = url;
        audioPlayer.style.display = 'block';
        audioPlayer.load();
        pendingAudioFile = new File([blob], 'journal.webm', { type: mimeType });
        document.getElementById('recordAudioBtn').textContent = 'Start Recording';
        document.getElementById('removeAudioBtn').style.display = 'block';
      };
      mediaRecorder.start();
      document.getElementById('recordAudioBtn').textContent = 'Stop Recording';
    } catch (err) {
      console.error('Error accessing microphone:', err);
    }
  }

  function handleAudioUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('audio/') && file.type !== 'video/mpeg') {
      alert('Please select an audio file');
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      alert('Audio file size should be less than 10MB');
      return;
    }
    pendingAudioFile = file;
    const url = URL.createObjectURL(file);
    const audioPlayer = document.getElementById('audioPlayer');
    audioPlayer.src = url;
    audioPlayer.style.display = 'block';
    audioPlayer.load();
    document.getElementById('removeAudioBtn').style.display = 'block';
  }

  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      alert('Image size should be less than 5MB');
      return;
    }
    pendingImageFile = file;
    const url = URL.createObjectURL(file);
    const preview = document.getElementById('imagePreview');
    preview.src = url;
    preview.style.display = 'block';
    document.getElementById('removeImageBtn').style.display = 'block';
  }

  function removeAudio() {
    const audioPlayer = document.getElementById('audioPlayer');
    const recordBtn = document.getElementById('recordAudioBtn');
    const audioInput = document.getElementById('audioFileInput');
    const date = document.getElementById('journalForm').dataset.date;
    audioPlayer.src = '';
    audioPlayer.style.display = 'none';
    audioInput.value = '';
    pendingAudioFile = null;
    delete journalAudios[date];
    saveUserData();
    document.getElementById('removeAudioBtn').style.display = 'none';
    recordBtn.textContent = 'Start Recording';
  }

  async function removeImage() {
    const preview = document.getElementById('imagePreview');
    const imageInput = document.getElementById('imageFileInput');
    const date = document.getElementById('journalForm').dataset.date;
    preview.src = '';
    preview.style.display = 'none';
    imageInput.value = '';
    pendingImageFile = null;
    try {
      if (journalImages[date]) {
        const objRef = ref(storage, journalImages[date]);
        await deleteObject(objRef);
      }
    } catch (err) {
      console.error('Error deleting image:', err);
    }
    delete journalImages[date];
    await saveUserData();
    document.getElementById('removeImageBtn').style.display = 'none';
  }

  /*******************************************************
   10) Events
  *******************************************************/
  function scheduleReminder(ev) {
    if (!ev.reminderDate || !ev.reminderTime) return;
    const reminderMoment = new Date(ev.reminderDate + 'T' + ev.reminderTime);
    const timeout = reminderMoment.getTime() - Date.now();
    if (timeout <= 0) return;
    const idx = events.indexOf(ev);
    if (reminderTimeouts[idx]) clearTimeout(reminderTimeouts[idx]);
    reminderTimeouts[idx] = setTimeout(() => {
      const timeRange = `${formatTime(ev.startTime)} - ${formatTime(ev.endTime)}`;
      const body = `${timeRange}: ${ev.description}`;
      if (Notification.permission === 'granted') {
        new Notification('Event Reminder', { body });
      }
      showReminderPopup(body);
    }, timeout);
  }

  function scheduleAllReminders() {
    Object.values(reminderTimeouts).forEach(clearTimeout);
    reminderTimeouts = {};
    events.forEach(scheduleReminder);
  }

  function scheduleTaskReminder(task) {
    if (!task.reminderDate || !task.reminderTime) return;
    const reminderMoment = new Date(task.reminderDate + 'T' + task.reminderTime);
    const timeout = reminderMoment.getTime() - Date.now();
    if (timeout <= 0) return;
    if (taskReminderTimeouts[task.id]) clearTimeout(taskReminderTimeouts[task.id]);
    taskReminderTimeouts[task.id] = setTimeout(() => {
      if (Notification.permission === 'granted') {
        new Notification('Task Reminder', { body: task.text });
      }
      showReminderPopup(task.text);
    }, timeout);
  }

  function scheduleAllTaskReminders() {
    Object.values(taskReminderTimeouts).forEach(clearTimeout);
    taskReminderTimeouts = {};
    Object.values(taskLists).forEach(list => list.forEach(scheduleTaskReminder));
  }

  async function showMissedReminders() {
    const lastOpen = userId ? userLastOpenTime : parseInt(localStorage.getItem('lastOpenTime') || '0', 10);
    const now = Date.now();
    const messages = [];

    events.forEach(ev => {
      if (!ev.reminderDate || !ev.reminderTime) return;
      const reminderMoment = new Date(ev.reminderDate + 'T' + ev.reminderTime);
      const t = reminderMoment.getTime();
      if (t > lastOpen && t <= now) {
        const timeRange = `${formatTime(ev.startTime)} - ${formatTime(ev.endTime)}`;
        const body = `${timeRange}: ${ev.description}`;
        if (Notification.permission === 'granted') {
          new Notification('Event Reminder', { body });
        }
        messages.push(body);
      }
    });

    Object.values(taskLists).forEach(list => list.forEach(task => {
      if (!task.reminderDate || !task.reminderTime) return;
      const reminderMoment = new Date(task.reminderDate + 'T' + task.reminderTime);
      const t = reminderMoment.getTime();
      if (t > lastOpen && t <= now) {
        if (Notification.permission === 'granted') {
          new Notification('Task Reminder', { body: task.text });
        }
        messages.push(task.text);
      }
    }));

    if (userId) {
      userLastOpenTime = now;
      try {
        await setDoc(doc(db, 'users', userId), { lastOpenTime: now }, { merge: true });
      } catch (err) {
        console.error('Error updating lastOpenTime:', err);
      }
    } else {
      localStorage.setItem('lastOpenTime', String(now));
    }
    messages.forEach(showReminderPopup);
    showMissedRemindersPopup(messages);
  }

  function showMissedRemindersPopup(messages) {
    if (!messages || messages.length === 0) return;
    const list = document.getElementById('missedRemindersList');
    list.innerHTML = '';
    messages.forEach(m => {
      const li = document.createElement('li');
      li.textContent = m;
      list.appendChild(li);
    });
    document.getElementById('missedRemindersPopup').style.display = 'flex';
  }

  function closeMissedRemindersPopup() {
    document.getElementById('missedRemindersPopup').style.display = 'none';
  }

  function showReminderPopup(message) {
    const el = document.getElementById('reminderPopupMsg');
    if (el) el.textContent = message;
    document.getElementById('reminderPopup').style.display = 'flex';
  }

  function closeReminderPopup() {
    document.getElementById('reminderPopup').style.display = 'none';
  }

  function showPendingNotifications() {
    showPastReminders = false;
    updatePendingRemindersList();
    document.getElementById('pendingRemindersPopup').style.display = 'flex';
  }

  function toggleReminderView() {
    showPastReminders = !showPastReminders;
    updatePendingRemindersList();
  }

  function updatePendingRemindersList() {
    const list = document.getElementById('pendingRemindersList');
    const title = document.getElementById('pendingRemindersTitle');
    const toggleBtn = document.getElementById('toggleReminderViewBtn');
    list.innerHTML = '';
    const now = Date.now();
    const reminders = [];

    events.forEach(ev => {
      if (!ev.reminderDate || !ev.reminderTime) return;
      const time = new Date(ev.reminderDate + 'T' + ev.reminderTime);
      reminders.push({ type: 'Event', desc: ev.description, time });
    });
    Object.values(taskLists).forEach(list => list.forEach(task => {
      if (!task.reminderDate || !task.reminderTime) return;
      const time = new Date(task.reminderDate + 'T' + task.reminderTime);
      reminders.push({ type: 'Task', desc: task.text, time });
    }));

    if (showPastReminders) {
      title.textContent = 'Past Reminders';
      toggleBtn.textContent = 'Show Upcoming';
      const past = reminders.filter(r => r.time.getTime() <= now)
                            .sort((a,b) => b.time - a.time)
                            .slice(0,10);
      if (past.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No past reminders';
        list.appendChild(li);
      } else {
        past.forEach(r => {
          const li = document.createElement('li');
          li.textContent = `${r.type}: ${r.desc} @ ${r.time.toLocaleString()}`;
          list.appendChild(li);
        });
      }
    } else {
      title.textContent = 'Pending Reminders';
      toggleBtn.textContent = 'Show Past';
      const upcoming = reminders.filter(r => r.time.getTime() > now)
                               .sort((a,b) => a.time - b.time);
      if (upcoming.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No pending notifications';
        list.appendChild(li);
      } else {
        upcoming.forEach(u => {
          const li = document.createElement('li');
          li.textContent = `${u.type}: ${u.desc} @ ${u.time.toLocaleString()}`;
          list.appendChild(li);
        });
      }
    }
  }

  function closePendingRemindersPopup() {
    document.getElementById('pendingRemindersPopup').style.display = 'none';
  }

  function addEvent(date) {
    const eventForm = document.getElementById('eventForm');
    document.getElementById('eventDate').value = date;
    document.getElementById('eventId').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventStartTime').value = '';
    document.getElementById('eventEndTime').value = '';
    document.getElementById('reminderDate').value = '';
    document.getElementById('reminderTime').value = '';
    eventForm.style.display = 'block';
    initializeColorPicker();
    document.querySelector('.delete-event-btn').style.display = 'none';
    eventForm.style.zIndex = '1002';
  }

  function editEvent(event, index) {
    const eventForm = document.getElementById('eventForm');
    document.getElementById('eventDate').value = event.date;
    document.getElementById('eventStartTime').value = event.startTime;
    document.getElementById('eventEndTime').value = event.endTime;
    document.getElementById('eventDescription').value = event.description;
    document.getElementById('eventId').value = index;
    document.getElementById('reminderDate').value = event.reminderDate || '';
    document.getElementById('reminderTime').value = event.reminderTime || '';
    selectedColor = event.color;
    eventForm.style.display = 'block';
    initializeColorPicker();
    document.querySelector('.delete-event-btn').style.display = 'block';
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(opt => {
      if (opt.style.backgroundColor === event.color) {
        opt.classList.add('selected');
      }
    });
    document.getElementById('journalForm').style.display = 'none';
  }

  function closeEventForm() {
    document.getElementById('eventForm').style.display = 'none';
    selectedColor = '#4285f4';
  }

  function getReminderMinutes({ date, startTime, reminderDate, reminderTime }) {
    if (!reminderDate || !reminderTime) return null;
    const startISO    = `${date}T${startTime}`;
    const remindISO   = `${reminderDate}T${reminderTime}`;
    const diffMs      = new Date(startISO) - new Date(remindISO);
    const diffMinutes = Math.round(diffMs / 60000);
    return diffMinutes > 0 ? diffMinutes : null;
  }

  async function saveEvent() {
    const date = document.getElementById('eventDate').value;
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const description = document.getElementById('eventDescription').value;
    const eventId = document.getElementById('eventId').value;
    const reminderDate = document.getElementById('reminderDate').value;
    const reminderTime = document.getElementById('reminderTime').value;

    if (!description || !startTime || !endTime) {
      alert('Please fill in all fields');
      return;
    }
    if (endTime <= startTime) {
      alert('End time must be after start time');
      return;
    }

    const eventData = { date, startTime, endTime, description, color: selectedColor, reminderDate, reminderTime };
    if (eventId !== '') {
      events[parseInt(eventId)] = eventData;
    } else {
      events.push(eventData);
    }

    try {
      const reminderMinutes = getReminderMinutes(eventData);
      await addDoc(collection(db, "events"), {
        title:     eventData.description,
        startTime: Timestamp.fromDate(new Date(`${eventData.date}T${eventData.startTime}`)),
        reminderMinutes,
        uid:       userId,
        emailSent: false
      });
    } catch (err) {
      console.error("❌ Failed to save event to Firestore:", err);
    }

    saveUserData();
    scheduleAllReminders();
    closeEventForm();
    generateCalendar();
    updateDailyEventsList(date);
  }

  function deleteEvent() {
    const eventId = document.getElementById('eventId').value;
    if (eventId !== '') {
      events.splice(parseInt(eventId), 1);
      saveUserData();
      scheduleAllReminders();
      closeEventForm();
      generateCalendar();
      const date = document.getElementById('eventDate').value;
      updateDailyEventsList(date);
    }
  }

 function updateDailyEventsList(date) {
  const list = document.getElementById("dailyEventsList");
  list.innerHTML = "";
  const dayEvents = events
    .filter(ev => ev.date === date)
    .sort((a, b) => a.startTime.localeCompare(b.startTime));

  if (dayEvents.length === 0) {
    list.innerHTML = "<p>No events scheduled for this day.</p>";
    return;
  }

  dayEvents.forEach(ev => {
    const div = document.createElement("div");
    div.className = "event";
    div.style.backgroundColor = ev.color;
    div.style.margin = "5px 0";
    div.style.padding = "8px";
    div.textContent = `${formatTime(ev.startTime)} - ${formatTime(ev.endTime)}: ${ev.description}`;
    div.onclick = () => editEvent(ev, events.indexOf(ev));
    list.appendChild(div);
  });
}

  /******************************************************* 11) Journal
  *******************************************************/
  async function saveJournal() {
      const date = document.getElementById('journalForm').dataset.date;
      const text = document.getElementById('journalText').value.trim();
      if (!userId) {
          alert("You must be signed in to save.");
          return;
      }
      try {
          if (pendingImageFile) {
              const imgRef = ref(storage, `journalImages/${userId}/${date}/${pendingImageFile.name}`);
              await uploadBytes(imgRef, pendingImageFile);
              journalImages[date] = await getDownloadURL(imgRef);
              console.log("Image uploaded for date:", date);
          }
          if (pendingAudioFile) {
              const audioRef = ref(storage, `journalAudios/${userId}/${date}/${pendingAudioFile.name}`);
              await uploadBytes(audioRef, pendingAudioFile);
              journalAudios[date] = await getDownloadURL(audioRef);
              console.log("Audio uploaded for date:", date);
          }
          journalEntries[date] = text;
          pendingAudioFile = null;
          pendingImageFile = null;
          await saveUserData();
          generateCalendar();
          updateDailyEventsList(date);
          closeJournalForm();
          console.log('✅ Journal saved with media synced');
      } catch (err) {
          console.error("Error in saveJournal:", err);
          alert("Error saving journal. Please try again. " + err.message);
      }
  }

  /******************************************************* 12) Goals
  *******************************************************/
  function goToGoalsPage() {
    closeJournalForm();
    document.getElementById('goalsForm').style.display = 'block';
  }

  function saveGoals() {
    saveUserData();
    closeGoalsForm();
  }

  function closeGoalsForm() {
    document.getElementById('goalsForm').style.display = 'none';
    document.getElementById('journalForm').style.display = 'block';
  }

  function goToJournalFromGoals() {
    document.getElementById('goalsForm').style.display = 'none';
    document.getElementById('journalForm').style.display = 'block';
    document.getElementById('prevDayButton').style.display = 'block';
    document.getElementById('nextDayButton').style.display = 'block';
  }

  /******************************************************* 13) Task Lists
  *******************************************************/
  function initializeTaskControls() {
      const taskToggleContainer = document.querySelector('.task-toggle');
      if (taskToggleContainer) {
          const freshContainer = taskToggleContainer.cloneNode(true);
          taskToggleContainer.parentNode.replaceChild(freshContainer, taskToggleContainer);
          freshContainer.addEventListener('click', (e) => {
              const button = e.target.closest('button');
              if (button) {
                  const onclickAttr = button.getAttribute('onclick');
                  if (onclickAttr) {
                      const listNameMatch = onclickAttr.match(/'([^']+)'/);
                      if (listNameMatch && listNameMatch[1]) {
                          switchTaskList(listNameMatch[1]);
                      }
                  }
              }
          });
      }

      document.getElementById('toggleCompletedBtn')?.addEventListener('click', toggleCompletedView);
      document.querySelector('.new-list-btn[onclick="createNewList()"]')?.addEventListener('click', createNewList);
      document.querySelector('.delete-list-btn')?.addEventListener('click', deleteCurrentList);
      document.querySelector('.clear-tasks-btn')?.addEventListener('click', clearAllTasks);
      document.querySelector('.add-task-btn')?.addEventListener('click', addTask);
      updateActiveTaskListButton();
      renderTasks();
  }

  function updateActiveTaskListButton() {
    document.querySelectorAll('.task-toggle button').forEach(btn => {
        const onclickAttr = btn.getAttribute('onclick');
        if (onclickAttr) {
            const listNameMatch = onclickAttr.match(/'([^']+)'/);
            if (listNameMatch && listNameMatch[1]) {
                btn.classList.toggle('active', listNameMatch[1] === currentTaskList);
            }
        }
    });
  }

  function switchTaskList(type) {
    currentTaskList = type;
    updateActiveTaskListButton();
    if (showingCompleted) {
      renderCompletedTasks();
    } else {
      renderTasks();
    }
  }

  function renderTaskListButtons() {
    const container = document.querySelector('.task-toggle');
    if (!container) return;
    container.querySelectorAll('button:not(#personalTasksBtn):not(#workTasksBtn)').forEach(btn => btn.remove());
    Object.keys(taskLists).forEach(key => {
      if (key === 'personal' || key === 'work') return;
      const btn = document.createElement('button');
      btn.textContent = key.replace(/-/g, ' ');
      btn.setAttribute('onclick', `switchTaskList('${key}')`);
      container.appendChild(btn);
    });
  }

  function createNewList() {
    const name = prompt("Name for new list:");
    if (!name) return;
    const key = name.toLowerCase().replace(/\s+/g, "-");
    if (taskLists[key]) return alert("That list already exists!");
    taskLists[key] = [];
    renderTaskListButtons();
    saveUserData();
    switchTaskList(key);
  }

  function deleteCurrentList() {
    if (["personal", "work"].includes(currentTaskList)) {
      alert("Can't delete default lists");
      return;
    }
    if (!confirm("Delete this list?")) return;
    delete taskLists[currentTaskList];
    currentTaskList = "personal";
    renderTaskListButtons();
    saveUserData();
    renderTasks();
  }

  function addTask() {
    const taskInput = document.getElementById('taskInput');
    const severitySelect = document.getElementById('taskSeverity');
    const text = taskInput.value.trim();
    if (!text) return alert("Please enter a task");
    const severity = parseInt(severitySelect.value, 10) || 0;
    const dateKey = document.getElementById('journalForm').dataset.date || formatLocalDate(new Date());
    if (!taskLists[currentTaskList]) taskLists[currentTaskList] = [];

    const tasks = text.split(',').map(t => t.trim()).filter(t => t);
    const baseId = Date.now();
    tasks.forEach((t, idx) => {
      const newTask = {
        text: t,
        id: baseId + idx,
        repeat: "none",
        startDate: dateKey,
        completed: false,
        completions: {},
        subtasks: [],
        collapsed: false,
        severity
      };
      taskLists[currentTaskList].push(newTask);
    });

    taskInput.value = "";
    severitySelect.value = '0';
    saveUserData();
    renderTasks();
  }

  function occursToday(task, dateKey) {
      if (task.exceptions && task.exceptions[dateKey]) return false;
      if (task.endDate && dateKey > task.endDate) return false;
      if (task.repeat === "none") return true;
      const d = new Date(dateKey + "T00:00:00");
      const start = new Date(task.startDate + "T00:00:00");
      if (d < start) return false;
      const day = d.getDay();
      const diffW = Math.floor((d - start) / 604800000);
      switch (task.repeat) {
        case "daily": return true;
        case "weekdays": return day >= 1 && day <= 5;
        case "weekends": return day === 0 || day === 6;
        case "weekly": return day === start.getDay();
        case "biweekly": return day === start.getDay() && diffW % 2 === 0;
        case "monthly": return d.getDate() === start.getDate();
        case "quarterly": return d.getDate() === start.getDate() && (d.getMonth() - start.getMonth()) % 3 === 0;
        case "semiannual": return d.getDate() === start.getDate() && (d.getMonth() - start.getMonth()) % 6 === 0;
        case "yearly": return d.getDate() === start.getDate() && d.getMonth() === start.getMonth();
        default: return true;
      }
  }

  function renderTasks() {
      const taskListEl = document.getElementById('taskList');
      if (!taskListEl) return;
      const showCompleted = showingCompleted;
      taskListEl.innerHTML = '';

      const currentTasks = taskLists[currentTaskList] || [];
      const filteredTasks = showCompleted ? currentTasks : currentTasks.filter(task => !task.completed);

      filteredTasks.sort((a, b) => (a.completed - b.completed) || (b.severity - a.severity));

      filteredTasks.forEach(task => {
          const taskItem = document.createElement('li');
          taskItem.className = 'task-item';
          if (task.completed) taskItem.classList.add('completed-task');
          taskItem.dataset.id = task.id;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = task.completed;
          checkbox.onchange = async () => {
              task.completed = checkbox.checked;
              if (task.completed && task.repeat && task.repeat !== 'none') {
                  await createNextRecurrence(task, currentTaskList);
              }
              await saveJournal();
              renderTasks();
          };

          const taskSpan = document.createElement('span');
          taskSpan.textContent = task.text;

          const controls = document.createElement('div');
          controls.className = 'task-item-controls';
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-task-btn';
          editBtn.innerHTML = 'ℹ️';
          editBtn.title = 'Edit Task Details';
          editBtn.onclick = () => openTaskEditor(task.id, currentTaskList);
          controls.appendChild(editBtn);

          taskItem.appendChild(checkbox);
          taskItem.appendChild(taskSpan);
          taskItem.appendChild(controls);

          taskListEl.appendChild(taskItem);
      });
  }

  function renderCompletedTasks() {
    const taskListEl = document.getElementById('taskList');
    taskListEl.innerHTML = '';
    const dateKey = document.getElementById('journalForm').dataset.date;
    const tasks = (completedTasks[dateKey] || []).filter(t => t.list === currentTaskList);
    if (tasks.length === 0) {
      const msg = document.createElement('p');
      msg.textContent = 'No completed tasks for this day.';
      msg.style.color = '#666';
      taskListEl.appendChild(msg);
      return;
    }
    tasks.forEach(task => {
      const li = document.createElement('li');
      li.className = 'task-item completed-task';
      const span = document.createElement('span');
      span.textContent = task.text;
      const restore = document.createElement('button');
      restore.textContent = '↺';
      restore.style.cssText = 'margin-left:auto;background:none;border:none;font-size:18px;cursor:pointer;color:#28a745;';
      restore.onclick = () => restoreTask(task.id, dateKey);
      li.append(span, restore);
      taskListEl.appendChild(li);
    });
  }

  function restoreTask(taskId, dateKey) {
    const list = completedTasks[dateKey] || [];
    const idx = list.findIndex(t => t.id == taskId);
    if (idx === -1) return;
    const [task] = list.splice(idx, 1);
    if (!taskLists[task.list]) taskLists[task.list] = [];
    if (task.repeat === 'none') {
      task.completed = false;
    } else if (task.completions) {
      delete task.completions[dateKey];
    }
    taskLists[task.list].push(task);
    saveUserData();
    if (showingCompleted) renderCompletedTasks();
    else renderTasks();
  }

  function toggleCompletedView() {
    showingCompleted = !showingCompleted;
    const btn = document.getElementById('toggleCompletedBtn');
    if (btn) btn.textContent = showingCompleted ? 'Show Active' : 'Show Completed';
    if (showingCompleted) {
      renderCompletedTasks();
    } else {
      renderTasks();
    }
  }
  
  /*******************************************************
   * CORRECTED Task Toggling Function
   *******************************************************/
  function toggleTask(taskId, dateKey) {
      const tasks = taskLists[currentTaskList];
      const taskIndex = tasks.findIndex(t => t.id == taskId);
      if (taskIndex === -1) return;

      const task = tasks[taskIndex];

      if (task.repeat === 'none') {
          // For non-repeating tasks, we don't set `completed: true` anymore.
          // We move it directly to the completedTasks list.
          if (!completedTasks[dateKey]) {
              completedTasks[dateKey] = [];
          }
          completedTasks[dateKey].push({ ...task, list: currentTaskList });
          
          // The FIX: Remove it from the active list.
          tasks.splice(taskIndex, 1);
          
      } else {
          // For repeating tasks, we add a completion entry for the specific date.
          task.completions = task.completions || {};
          task.completions[dateKey] = true;
      }
      
      const li = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
      if (li) {
          li.classList.add('fade-out');
          setTimeout(() => li.remove(), 500);
      }

      saveUserData();
  }

  function deleteTask(taskId) {
      const tasks = taskLists[currentTaskList];
      const taskIndex = tasks.findIndex(t => t.id == taskId);
      if (taskIndex === -1) return;
      const task = tasks[taskIndex];
      const dateKey = document.getElementById('journalForm').dataset.date;
      if (task.repeat && task.repeat !== 'none') {
          const choice = prompt("This is a repeating task. Do you want to delete:\n1. Only this occurrence\n2. This and all future occurrences\n\nEnter 1 or 2. (Cancel to abort)");
          if (choice === '1') {
              task.exceptions = task.exceptions || {};
              task.exceptions[dateKey] = true;
          } else if (choice === '2') {
              const yesterday = new Date(dateKey);
              yesterday.setDate(yesterday.getDate() - 1);
              task.endDate = yesterday.toISOString().split('T')[0];
          } else {
              return;
          }
      } else {
          tasks.splice(taskIndex, 1);
      }
      saveUserData();
      renderTasks();
  }

  function toggleWeeklyOptions(value) {
      const weeklyOptions = document.getElementById('weeklyRepeatOptions');
      weeklyOptions.style.display = (value === 'weekly') ? 'block' : 'none';
  }

  function openTaskEditor(taskId, listName) {
      editingTaskInfo = { id: taskId, listName: listName };
      const task = taskLists[listName]?.find(t => t.id === taskId);
      if (!task) {
        console.error("Task not found for editing!");
        return;
      }

      document.getElementById('taskEditText').value = task.text;
      document.getElementById('taskReminderId').value = task.id;
      document.getElementById('taskReminderSeverity').value = task.severity || '0';
      document.getElementById('taskReminderDate').value = task.reminderDate || '';
      document.getElementById('taskReminderTime').value = task.reminderTime || '';

      const repeatSelect = document.getElementById('taskRepeat');
      repeatSelect.value = task.repeat || 'none';
      toggleWeeklyOptions(repeatSelect.value);

      if (task.repeat === 'weekly') {
        document.querySelectorAll('input[name="repeatDay"]').forEach(radio => radio.checked = false);
        if (task.repeatDay !== undefined) {
          const dayRadio = document.querySelector(`input[name="repeatDay"][value="${task.repeatDay}"]`);
          if (dayRadio) dayRadio.checked = true;
        }
      }

      document.getElementById('taskReminderForm').style.display = 'block';
  }

  async function saveTaskDetails() {
      const { id: taskId, listName } = editingTaskInfo;
      if (!taskId || !listName) {
        console.error("No task is being edited.");
        return;
      }

      const taskIndex = taskLists[listName]?.findIndex(t => t.id === taskId);
      if (taskIndex === -1) {
        console.error("Task to save not found!");
        return;
      }

      const task = taskLists[listName][taskIndex];
      task.text = document.getElementById('taskEditText').value.trim();
      task.severity = document.getElementById('taskReminderSeverity').value;
      task.reminderDate = document.getElementById('taskReminderDate').value;
      task.reminderTime = document.getElementById('taskReminderTime').value;
      task.repeat = document.getElementById('taskRepeat').value;

      if (task.repeat === 'weekly') {
        const selectedDayRadio = document.querySelector('input[name="repeatDay"]:checked');
        if (selectedDayRadio) {
          task.repeatDay = parseInt(selectedDayRadio.value, 10);
        } else {
          alert("For weekly repeats, please select a day.");
          return;
        }
      } else {
        delete task.repeatDay;
      }

      await saveJournal();
      closeTaskReminderForm();
      renderTasks();
  }

  async function createNextRecurrence(completedTask, listName) {
      const todayStr = document.getElementById('journalForm').dataset.date;
      const today = new Date(todayStr + 'T12:00:00');
      let nextDate = new Date(today);

      switch (completedTask.repeat) {
          case 'daily':
              nextDate.setDate(today.getDate() + 1);
              break;
          case 'weekly':
              nextDate.setDate(today.getDate() + 7);
              break;
          default:
              return;
      }

      const nextDateStr = nextDate.toISOString().split('T')[0];

      const newTask = {
          ...completedTask,
          id: `task_${Date.now()}`,
          completed: false,
          subtasks: completedTask.subtasks ? completedTask.subtasks.map(st => ({...st, completed: false})) : [],
      };

      const dateDocRef = doc(db, 'users', userId, 'journal', nextDateStr);

      try {
          const dateDoc = await getDoc(dateDocRef);
          let dateData = dateDoc.exists() ? dateDoc.data() : { taskLists: { personal: [], work: [] } };

          if (!dateData.taskLists) dateData.taskLists = { personal: [], work: [] };
          if (!dateData.taskLists[listName]) dateData.taskLists[listName] = [];

          dateData.taskLists[listName].push(newTask);

          await setDoc(dateDocRef, dateData, { merge: true });
          console.log(`Created recurring task for ${nextDateStr}`);
      } catch (error) {
          console.error("Error creating recurring task:", error);
      }
  }

  function closeTaskReminderForm() {
    document.getElementById("taskReminderForm").style.display = "none";
  }

  window._openTaskEditor = openTaskEditor;
  window._saveTaskDetails = saveTaskDetails;
  window._closeTaskReminderForm = closeTaskReminderForm;
  window._toggleWeeklyOptions = toggleWeeklyOptions;

  // Make functions available globally to be called from HTML
  Object.assign(window, {
    loginWithGoogle, previousMonth, nextMonth, openJournal, openJournalMode,
    closeJournalForm, changeJournalDay, addEvent, saveEvent, closeEventForm,
    deleteEvent, saveJournal, toggleRecording, handleAudioUpload,
    handleImageUpload, removeAudio, removeImage, goToGoalsPage, saveGoals,
    closeGoalsForm, goToJournalFromGoals, changeToHabit, changeToJournal,
    showNewHabitForm, confirmAddHabit, cancelAddHabit, deleteHabit,
    saveHabitTracker, cancelHabitTracker, logoutFromGoogle, addTask,
    toggleTask, deleteTask, switchTaskList, createNewList, deleteCurrentList,
    toggleCompletedView, showPendingNotifications, closeMissedRemindersPopup, closeReminderPopup,
    closePendingRemindersPopup, toggleReminderView
  });

  initializeTaskControls();
  generateCalendar();
  scheduleAllReminders();
  scheduleAllTaskReminders();

  document.getElementById('pendingBtn').addEventListener('click', showPendingNotifications);
  document.getElementById('logoutButton').addEventListener('click', _logoutFromGoogle);

  // Implement the habit functions
function _changeToHabit() {
  const journalForm = document.getElementById('journalForm');
  const habitForm = document.getElementById('habitForm');
  const date = journalForm.dataset.date;
  journalForm.style.display = 'none';
  habitForm.style.display = 'block';
  habitForm.dataset.date = date;
  document.getElementById('habitDate').textContent = new Date(date + 'T00:00:00').toLocaleDateString();
  renderHabits(date);
}
function _changeToJournal() {
  document.getElementById('habitForm').style.display = 'none';
  document.getElementById('journalForm').style.display = 'block';
}
function _showNewHabitForm() {
  document.getElementById('newHabitForm').style.display = 'block';
}
function _confirmAddHabit() {
  const habitName = document.getElementById('newHabitName').value.trim();
  if (!habitName) return alert('Please enter a habit name');
  const habitType = document.querySelector('input[name="habitType"]:checked').value;
  const startDate = document.getElementById('habitForm').dataset.date || new Date().toISOString().split('T')[0];
  globalHabits.push({
    id: Date.now(),
    name: habitName,
    type: habitType,
    startDate
  });
  saveUserData();
  document.getElementById('newHabitForm').style.display = 'none';
  renderHabits(document.getElementById('habitForm').dataset.date);
}
function _cancelAddHabit() {
  document.getElementById('newHabitForm').style.display = 'none';
}
function _deleteHabit(habitId) {
  if (!confirm('Delete this habit?')) return;
  globalHabits = globalHabits.filter(h => h.id !== habitId);
  for (const date in habitTracker) {
    if (habitTracker[date] && habitTracker[date][habitId]) {
      delete habitTracker[date][habitId];
      if (Object.keys(habitTracker[date]).length === 0) {
        delete habitTracker[date];
      }
    }
  }
  saveUserData();
  renderHabits(document.getElementById('habitForm').dataset.date);
}
function _saveHabitTracker() {
  saveUserData();
  document.getElementById('habitForm').style.display = 'none';
  document.getElementById('journalForm').style.display = 'block';
}
function _cancelHabitTracker() {
  document.getElementById('habitForm').style.display = 'none';
  document.getElementById('journalForm').style.display = 'block';
}
function renderHabits(date) {
  const habitList = document.getElementById('habitList');
  habitList.innerHTML = '';
  if (globalHabits.length === 0) {
    habitList.innerHTML = '<p>No habits created yet. Click "Add Habit" to get started.</p>';
    return;
  }
  globalHabits
    .filter(habit => !habit.startDate || habit.startDate <= date)
    .forEach(habit => {
      const div = document.createElement('div');
      div.style.cssText = 'margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:4px; display:flex; align-items:center; justify-content:space-between;';
      const label = document.createElement('label');
      label.style.cssText = 'display:flex; align-items:center;';
      if (habit.type === 'check') {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.style.marginRight = '10px';
        checkbox.checked = habitTracker[date]?.[habit.id]?.completed || false;
        checkbox.onchange = () => {
          habitTracker[date] = habitTracker[date] || {};
          habitTracker[date][habit.id] = habitTracker[date][habit.id] || {};
          habitTracker[date][habit.id].completed = checkbox.checked;
        };
        label.appendChild(checkbox);
      } else {
        const count = document.createElement('input');
        count.type = 'number';
        count.min = '0';
        count.step = 'any';
        count.style.cssText = 'width:60px; margin-right:10px;';
        count.value = habitTracker[date]?.[habit.id]?.count || 0;
        count.onchange = () => {
          habitTracker[date] = habitTracker[date] || {};
          habitTracker[date][habit.id] = habitTracker[date][habit.id] || {};
          habitTracker[date][habit.id].count = parseFloat(count.value) || 0;
        };
        label.appendChild(count);
      }
      const name = document.createElement('span');
      name.textContent = habit.name;
      label.appendChild(name);
      div.appendChild(label);
      const del = document.createElement('button');
      del.innerHTML = '&times;';
      del.style.cssText = 'background:none; color:#dc3545; border:none; font-size:24px; cursor:pointer;';
      del.onclick = () => _deleteHabit(habit.id);
      div.appendChild(del);
      habitList.appendChild(div);
    });
}
window._changeToHabit = _changeToHabit;
window._changeToJournal = _changeToJournal;
window._showNewHabitForm = _showNewHabitForm;
window._confirmAddHabit = _confirmAddHabit;
window._cancelAddHabit = _cancelAddHabit;
window._deleteHabit = _deleteHabit;
window._saveHabitTracker = _saveHabitTracker;
window._cancelHabitTracker = _cancelHabitTracker;

</script>

</body>
</html>
